import{b as te,r,j as e}from"./index-jlwN39o6.js";import{A as ae,P}from"./AppShell-DqOjJXDS.js";import{C as X}from"./card-CRmQ0_oL.js";import{I,B as se}from"./offlineCache-DkBvSVfm.js";import{L as N}from"./label-DJrY3LZM.js";import{S as L,a as G,b as _,c as q,d as J}from"./select-BQzIMXLs.js";import{T as H}from"./truck-DvsC4l-w.js";import{A as re}from"./arrow-right-BwxvBiXj.js";import{S as oe}from"./scale-C-rnqUHd.js";function ge(){const{toast:x}=te(),[M,C]=r.useState(!1),[R,Q]=r.useState([]),[T,U]=r.useState([]),[V,W]=r.useState([]),[B,Y]=r.useState([]),[m,A]=r.useState(""),[g,E]=r.useState(""),[n,y]=r.useState(""),[h,z]=r.useState(""),[f,$]=r.useState(""),[w,K]=r.useState(""),d=R.find(t=>t.id.toString()===m),k=T.find(t=>t.id.toString()===g),i=d?.unidad==="MIXTO",O=V.find(t=>t.productoId.toString()===m),S=B.find(t=>t.productoId.toString()===m),b=O?parseFloat(O.cantidad):0,j=S&&parseInt(S.cantidadPiezas)||0,v=S&&parseFloat(S.cantidadKg)||0,D=async()=>{try{const t=localStorage.getItem("auth_token"),[a,s,o,p]=await Promise.all([fetch("/api/productos",{headers:{Authorization:`Bearer ${t}`}}),fetch("/api/rutas",{headers:{Authorization:`Bearer ${t}`}}),fetch("/api/bodega",{headers:{Authorization:`Bearer ${t}`}}),fetch("/api/bodega/mixto",{headers:{Authorization:`Bearer ${t}`}})]);if(a.ok){const l=((await a.json()).productos||[]).sort((u,F)=>u.id-F.id);Q(l)}else console.error("Error cargando productos:",a.status);if(s.ok){const l=((await s.json()).rutas||[]).sort((u,F)=>u.id-F.id);U(l)}if(o.ok){const c=await o.json();W(c.inventario||[])}if(p.ok){const c=await p.json();Y(c.inventario||[])}}catch(t){console.error("Error cargando datos:",t)}};r.useEffect(()=>{D()},[]);const Z=async t=>{if(t.preventDefault(),!m||!g){x({title:"Validación",description:"Selecciona producto y ruta.",variant:"destructive"});return}if(i){const a=parseInt(h)||0,s=parseFloat(f)||0;if(a<=0&&s<=0){x({title:"Validación",description:"Ingresa piezas y/o kilogramos.",variant:"destructive"});return}if(a>j){x({title:"Stock insuficiente",description:`Solo hay ${j} piezas disponibles.`,variant:"destructive"});return}if(s>v){x({title:"Stock insuficiente",description:`Solo hay ${v.toFixed(3)} kg disponibles.`,variant:"destructive"});return}}else{if(!n||parseFloat(n)<=0){x({title:"Validación",description:"Ingresa una cantidad válida.",variant:"destructive"});return}if(parseFloat(n)>b){x({title:"Stock insuficiente",description:`Solo hay ${b.toFixed(2)} disponibles en bodega.`,variant:"destructive"});return}}C(!0);try{const a=localStorage.getItem("auth_token");let s="",o={};i?(s="/api/bodega/mover-mixto-a-ruta",o={productoId:parseInt(m),rutaId:parseInt(g),piezas:parseInt(h)||0,kg:parseFloat(f)||0,notas:w.trim()||void 0}):(s="/api/bodega/mover-a-ruta",o={productoId:parseInt(m),rutaId:parseInt(g),cantidad:parseFloat(n),notas:w.trim()||void 0});const p=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(o)});if(!p.ok){const l=await p.json();throw new Error(l.error||"Error al mover stock")}let c="";if(i){const l=parseInt(h)||0,u=parseFloat(f)||0;c=`Se movieron ${l>0?l+" pzs":""}${l>0&&u>0?" + ":""}${u>0?u+" kg":""} de ${d?.nombre} a ${k?.nombre}.`}else c=`Se movieron ${n} ${d?.unidad==="KG"?"kg":"piezas"} de ${d?.nombre} a ${k?.nombre}.`;x({title:"Éxito",description:c}),y(""),z(""),$(""),K(""),A(""),E(""),D()}catch(a){x({title:"Error",description:a.message,variant:"destructive"})}finally{C(!1)}},ee=t=>{if(t.unidad==="MIXTO"){const a=B.find(p=>p.productoId===t.id),s=a&&parseInt(a.cantidadPiezas)||0,o=a&&parseFloat(a.cantidadKg)||0;return{haStock:s>0||o>0,display:`${s} pz / ${o.toFixed(2)} kg`}}else{const a=V.find(o=>o.productoId===t.id),s=a?parseFloat(a.cantidad):0;return{haStock:s>0,display:`${s.toFixed(2)} ${t.unidad}`}}};return e.jsx(ae,{title:"Mover Stock",children:e.jsx("div",{className:"grid gap-6 pb-20",children:e.jsxs(X,{className:"p-6 rounded-3xl border-none shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"grid h-12 w-12 place-items-center rounded-2xl bg-blue-500/10",children:e.jsx(H,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-black",children:"Mover Stock"}),e.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Transferir de bodega a ruta"})]})]}),e.jsxs("form",{onSubmit:Z,className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(N,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Producto (ID - Nombre)"}),e.jsxs(L,{value:m,onValueChange:t=>{A(t),y(""),z(""),$("")},children:[e.jsx(G,{className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-producto",children:e.jsx(_,{placeholder:"Seleccionar producto..."})}),e.jsx(q,{className:"rounded-2xl max-h-60",children:R.map(t=>{const a=ee(t);return e.jsx(J,{value:t.id.toString(),className:"font-bold",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-primary font-black",children:["#",t.id]}),e.jsxs("span",{children:["- ",t.nombre]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${t.unidad==="MIXTO"?"bg-purple-500/20 text-purple-700":""} ${a.haStock?"text-green-500":"text-red-500"}`,children:["(",a.display,")"]})]})},t.id)})})]})]}),d&&e.jsx(X,{className:"p-3 rounded-2xl bg-primary/5 border-primary/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-black",children:"Producto seleccionado:"}),e.jsxs("div",{className:"text-sm font-bold text-primary",children:["#",d.id," - ",d.nombre,i&&e.jsx("span",{className:"ml-2 text-xs px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-700",children:"MIXTO"})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-[9px] font-black uppercase text-muted-foreground",children:"Stock bodega"}),i?e.jsxs("div",{className:"text-sm font-black",children:[e.jsxs("span",{className:j>0?"text-green-500":"text-red-500",children:[j," pz"]}),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"/"}),e.jsxs("span",{className:v>0?"text-green-500":"text-red-500",children:[v.toFixed(3)," kg"]})]}):e.jsx("div",{className:`text-lg font-black ${b>0?"text-green-500":"text-red-500"}`,children:b.toFixed(2)})]})]})}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(N,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Ruta Destino"}),e.jsxs(L,{value:g,onValueChange:E,children:[e.jsx(G,{className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-ruta",children:e.jsx(_,{placeholder:"Seleccionar ruta..."})}),e.jsx(q,{className:"rounded-2xl max-h-60 overflow-y-auto",children:T.map(t=>e.jsx(J,{value:t.id.toString(),className:"font-bold",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-primary font-black",children:["#",t.id]}),e.jsxs("span",{children:["- ",t.nombre]})]})},t.id))})]})]}),d&&k&&e.jsxs("div",{className:"flex items-center justify-center gap-4 py-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[9px] font-black uppercase text-muted-foreground",children:"Bodega"}),i?e.jsxs("div",{className:"text-sm font-black",children:[j," pz / ",v.toFixed(2)," kg"]}):e.jsx("div",{className:"text-sm font-black",children:b.toFixed(2)})]}),e.jsx(re,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[9px] font-black uppercase text-muted-foreground",children:k.nombre}),i?e.jsxs("div",{className:"text-sm font-black text-primary",children:["+",h||"0"," pz / +",f||"0"," kg"]}):e.jsxs("div",{className:"text-sm font-black text-primary",children:["+",n||"0"]})]})]}),i?e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsxs(N,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground flex items-center gap-1",children:[e.jsx(P,{className:"h-3 w-3"})," Piezas"]}),e.jsx(I,{type:"number",step:"1",min:"0",max:j,value:h,onChange:t=>z(t.target.value),placeholder:"0",className:"h-12 rounded-2xl bg-muted/30 border-none font-bold text-lg text-center","data-testid":"input-piezas"})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsxs(N,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground flex items-center gap-1",children:[e.jsx(oe,{className:"h-3 w-3"})," Kilogramos"]}),e.jsx(I,{type:"number",step:"0.001",min:"0",max:v,value:f,onChange:t=>$(t.target.value),placeholder:"0.000",className:"h-12 rounded-2xl bg-muted/30 border-none font-bold text-lg text-center","data-testid":"input-kg"})]})]}):e.jsxs("div",{className:"grid gap-1.5",children:[e.jsxs(N,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:["Cantidad a mover (",d?.unidad==="KG"?"Kilogramos":"Piezas",")"]}),e.jsx(I,{type:"number",step:"0.001",min:"0",max:b,value:n,onChange:t=>y(t.target.value),placeholder:"0.00",className:"h-12 rounded-2xl bg-muted/30 border-none font-bold text-lg text-center","data-testid":"input-cantidad"})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(N,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Notas (opcional)"}),e.jsx(I,{value:w,onChange:t=>K(t.target.value),placeholder:"Ej: Carga del día",className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"input-notas"})]}),e.jsx(se,{type:"submit",disabled:M||!m||!g||(i?(parseInt(h)||0)<=0&&(parseFloat(f)||0)<=0:!n||parseFloat(n)<=0),className:"h-14 rounded-2xl font-black uppercase text-sm mt-2","data-testid":"button-submit",children:M?"Moviendo...":"Mover Stock a Ruta"})]})]})})})}export{ge as default};
