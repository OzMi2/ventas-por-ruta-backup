import{b as U,r as c,j as e}from"./index-B_foZYmG.js";import{A as F,P as q,B as f,U as L}from"./AppShell-C0i3IliG.js";import{B as u,I as C}from"./api-BvF3Zc_M.js";import{C as j}from"./card-BOyt3Fg8.js";import{D as M,a as _,b as H,c as X,d as J}from"./dialog-CwTbF-Ej.js";import{L as m}from"./label-B3OYdbl4.js";import{S as x,a as p,b as h,c as g,d as o}from"./select-j9o4lc39.js";import{f as W,c as Y,d as ee}from"./discounts-BivUuf5T.js";import{P}from"./plus-CG2hWGoQ.js";import{T as v}from"./trash-2--JHM1OHN.js";function ue(){const{toast:i}=U(),[I,A]=c.useState([]),[$,E]=c.useState([]),[T,z]=c.useState([]),[k,K]=c.useState([]),[V,b]=c.useState(!1),[a,r]=c.useState({tipo:"volumen",rutaId:null,clienteId:null,productoId:null,mode:"KG",tiers:[{minQty:1,discountAmount:0}]}),G=a.rutaId?$.filter(t=>t.rutaId===a.rutaId):[],N=async()=>{try{const t=await W();A(Array.isArray(t)?t:[]);const s=localStorage.getItem("auth_token"),[n,l,O]=await Promise.all([fetch("/api/rutas",{headers:{Authorization:`Bearer ${s}`}}).then(d=>d.json()),fetch("/api/clientes?all=true",{headers:{Authorization:`Bearer ${s}`}}).then(d=>d.json()),fetch("/api/productos",{headers:{Authorization:`Bearer ${s}`}}).then(d=>d.json())]);z(n.rutas||[]),E((l.clientes||[]).map(d=>({id:d.id,nombre:d.nombre,rutaId:d.rutaId}))),K((O.productos||[]).map(d=>({id:d.id,nombre:d.nombre,unidad:d.unidad})))}catch{i({title:"Error",description:"No se pudo cargar la información.",variant:"destructive"})}};c.useEffect(()=>{N()},[]);const R=async()=>{if(!a.productoId||!a.tiers.length){i({title:"Validación",description:"Selecciona un producto y al menos un nivel de descuento.",variant:"destructive"});return}if(a.tipo==="cliente"&&!a.clienteId){i({title:"Validación",description:"Selecciona un cliente para el descuento específico.",variant:"destructive"});return}try{await Y({productoId:a.productoId,mode:a.mode,tiers:a.tiers,clienteId:a.tipo==="cliente"?a.clienteId:null}),i({title:"Creado",description:"Nueva regla de descuento creada."}),b(!1),N()}catch{i({title:"Error",description:"No se pudo guardar.",variant:"destructive"})}},y=async t=>{if(confirm("¿Eliminar esta regla de descuento?"))try{await ee(t),i({title:"Eliminado",description:"Regla eliminada."}),N()}catch{i({title:"Error",description:"No se pudo eliminar.",variant:"destructive"})}},S=(t,s)=>{r(n=>{const l=[...n.tiers];return l[t]&&(l[t]={...l[t],...s}),{...n,tiers:l}})},B=()=>{r(t=>({...t,tiers:[...t.tiers,{minQty:0,discountAmount:0}]}))},Q=t=>{r(s=>({...s,tiers:s.tiers.filter((n,l)=>l!==t)}))},Z=()=>{r({tipo:"volumen",rutaId:null,clienteId:null,productoId:null,mode:"KG",tiers:[{minQty:1,discountAmount:0}]}),b(!0)},D=I.filter(t=>t.clienteId===null),w=I.filter(t=>t.clienteId!==null);return e.jsx(F,{title:"Gestión de Descuentos",children:e.jsxs("div",{className:"grid gap-6 pb-20",children:[e.jsxs("div",{className:"flex justify-between items-center px-1",children:[e.jsx("h2",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground",children:"Reglas de Descuento"}),e.jsxs(u,{size:"sm",onClick:Z,className:"h-9 rounded-xl font-black uppercase text-[10px] gap-2","data-testid":"button-new-discount",children:[e.jsx(P,{className:"h-3 w-3"})," Nuevo"]})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 px-1",children:[e.jsx(q,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-wider text-muted-foreground",children:"Descuentos por Volumen (Aplican a todos)"})]}),D.length===0?e.jsxs(j,{className:"p-6 text-center rounded-3xl bg-muted/20 border-dashed",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin descuentos por volumen"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"Crea un descuento que aplique a todos los clientes según la cantidad comprada."})]}):D.map(t=>e.jsxs(j,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60","data-testid":`card-discount-${t.id}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(f,{variant:"default",className:"text-[8px] font-black bg-blue-500",children:"TODOS"}),e.jsx(f,{variant:"outline",className:"text-[8px] font-black uppercase border-primary text-primary",children:t.mode})]}),e.jsx("div",{className:"text-sm font-black truncate",children:t.productoNombre||`Producto #${t.productoId}`})]}),e.jsx(u,{variant:"destructive",size:"sm",onClick:()=>t.id&&y(t.id),className:"h-7 rounded-full text-[9px] font-black uppercase","data-testid":`button-delete-discount-${t.id}`,children:e.jsx(v,{className:"h-3 w-3"})})]}),e.jsx("div",{className:"mt-3 grid grid-cols-2 gap-2",children:t.tiers.map((s,n)=>e.jsxs("div",{className:"bg-background/40 p-2 rounded-xl border border-muted/50",children:[e.jsxs("div",{className:"text-[7px] font-black text-muted-foreground uppercase leading-none",children:["Desde ",t.mode==="PIEZA"?"Pzs":t.mode==="KG"?"Kg":"Unidades"]}),e.jsxs("div",{className:"text-xs font-black",children:[s.minQty," → ",e.jsxs("span",{className:"text-green-500",children:["-$",s.discountAmount,"/u"]})]})]},n))})]},t.id))]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 px-1",children:[e.jsx(L,{className:"h-4 w-4 text-orange-500"}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-wider text-muted-foreground",children:"Descuentos por Cliente (Solo para cliente específico)"})]}),w.length===0?e.jsxs(j,{className:"p-6 text-center rounded-3xl bg-muted/20 border-dashed",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin descuentos por cliente"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"Crea un descuento especial para un cliente en particular."})]}):w.map(t=>e.jsxs(j,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60","data-testid":`card-discount-${t.id}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(f,{variant:"default",className:"text-[8px] font-black bg-orange-500",children:"CLIENTE"}),e.jsx(f,{variant:"outline",className:"text-[8px] font-black uppercase border-primary text-primary",children:t.mode})]}),e.jsx("div",{className:"text-sm font-black truncate",children:t.clienteNombre||`Cliente #${t.clienteId}`}),e.jsx("div",{className:"text-xs text-muted-foreground font-medium",children:t.productoNombre||`Producto #${t.productoId}`})]}),e.jsx(u,{variant:"destructive",size:"sm",onClick:()=>t.id&&y(t.id),className:"h-7 rounded-full text-[9px] font-black uppercase","data-testid":`button-delete-discount-${t.id}`,children:e.jsx(v,{className:"h-3 w-3"})})]}),e.jsx("div",{className:"mt-3 grid grid-cols-2 gap-2",children:t.tiers.map((s,n)=>e.jsxs("div",{className:"bg-background/40 p-2 rounded-xl border border-muted/50",children:[e.jsxs("div",{className:"text-[7px] font-black text-muted-foreground uppercase leading-none",children:["Desde ",t.mode==="PIEZA"?"Pzs":t.mode==="KG"?"Kg":"Unidades"]}),e.jsxs("div",{className:"text-xs font-black",children:[s.minQty," → ",e.jsxs("span",{className:"text-green-500",children:["-$",s.discountAmount,"/u"]})]})]},n))})]},t.id))]}),e.jsx(M,{open:V,onOpenChange:b,children:e.jsxs(_,{className:"max-w-[95%] rounded-3xl",children:[e.jsx(H,{children:e.jsx(X,{className:"font-black uppercase text-center text-sm",children:"Nueva Regla de Descuento"})}),e.jsxs("div",{className:"grid gap-4 py-2 max-h-[60vh] overflow-y-auto px-1",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(m,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Tipo de Descuento"}),e.jsxs(x,{value:a.tipo,onValueChange:t=>r(s=>({...s,tipo:t,clienteId:null})),children:[e.jsx(p,{className:"h-11 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-discount-type",children:e.jsx(h,{})}),e.jsxs(g,{className:"rounded-2xl",children:[e.jsx(o,{value:"volumen",className:"font-bold",children:"Por Volumen (Aplica a todos)"}),e.jsx(o,{value:"cliente",className:"font-bold",children:"Por Cliente (Solo cliente específico)"})]})]})]}),a.tipo==="cliente"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(m,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Ruta"}),e.jsxs(x,{value:a.rutaId?.toString()||"",onValueChange:t=>r(s=>({...s,rutaId:parseInt(t),clienteId:null})),children:[e.jsx(p,{className:"h-11 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-ruta",children:e.jsx(h,{placeholder:"Primero selecciona una ruta..."})}),e.jsx(g,{className:"rounded-2xl max-h-60",children:T.map(t=>e.jsx(o,{value:t.id.toString(),className:"font-bold",children:t.nombre},t.id))})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(m,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Cliente"}),e.jsxs(x,{value:a.clienteId?.toString()||"",onValueChange:t=>r(s=>({...s,clienteId:parseInt(t)})),disabled:!a.rutaId,children:[e.jsx(p,{className:"h-11 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-client",children:e.jsx(h,{placeholder:a.rutaId?"Seleccionar cliente...":"Selecciona una ruta primero"})}),e.jsx(g,{className:"rounded-2xl max-h-60",children:G.map(t=>e.jsx(o,{value:t.id.toString(),className:"font-bold",children:t.nombre},t.id))})]})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(m,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Producto"}),e.jsxs(x,{value:a.productoId?.toString()||"",onValueChange:t=>{const s=k.find(n=>n.id===parseInt(t));r(n=>({...n,productoId:parseInt(t),mode:s?.unidad==="PIEZA"?"PIEZA":"KG"}))},children:[e.jsx(p,{className:"h-11 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-product",children:e.jsx(h,{placeholder:"Seleccionar producto..."})}),e.jsx(g,{className:"rounded-2xl max-h-60",children:k.map(t=>e.jsxs(o,{value:t.id.toString(),className:"font-bold",children:[t.nombre," (",t.unidad,")"]},t.id))})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(m,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Unidad"}),e.jsxs(x,{value:a.mode,onValueChange:t=>r(s=>({...s,mode:t})),children:[e.jsx(p,{className:"h-11 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-mode",children:e.jsx(h,{})}),e.jsxs(g,{className:"rounded-2xl",children:[e.jsx(o,{value:"PIEZA",className:"font-bold",children:"Por Piezas"}),e.jsx(o,{value:"KG",className:"font-bold",children:"Por Kilogramos"}),e.jsx(o,{value:"MIXTO",className:"font-bold",children:"Mixto"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(m,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Niveles de Descuento (Cantidad mínima → Descuento por unidad)"}),e.jsxs(u,{size:"sm",variant:"ghost",onClick:B,className:"h-6 text-[9px] font-black uppercase gap-1",children:[e.jsx(P,{className:"h-3 w-3"})," Añadir"]})]}),a.tiers.map((t,s)=>e.jsxs("div",{className:"flex gap-2 items-center bg-muted/20 p-2 rounded-xl",children:[e.jsxs("div",{className:"flex-1 grid gap-1",children:[e.jsxs("span",{className:"text-[8px] font-bold text-muted-foreground uppercase",children:["Desde (",a.mode==="PIEZA"?"pzs":a.mode==="KG"?"kg":"u",")"]}),e.jsx(C,{type:"number",value:t.minQty,onChange:n=>S(s,{minQty:Number(n.target.value)}),className:"h-9 rounded-xl bg-background border-none text-center font-bold","data-testid":`input-tier-qty-${s}`})]}),e.jsxs("div",{className:"flex-1 grid gap-1",children:[e.jsx("span",{className:"text-[8px] font-bold text-muted-foreground uppercase",children:"Descuento $"}),e.jsx(C,{type:"number",step:"0.01",value:t.discountAmount,onChange:n=>S(s,{discountAmount:Number(n.target.value)}),className:"h-9 rounded-xl bg-background border-none text-center font-bold","data-testid":`input-tier-discount-${s}`})]}),a.tiers.length>1&&e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>Q(s),className:"h-8 w-8 text-destructive",children:e.jsx(v,{className:"h-4 w-4"})})]},s)),e.jsxs("div",{className:"text-[9px] text-muted-foreground bg-muted/30 p-2 rounded-xl",children:[e.jsx("strong",{children:"Ejemplo:"}),' Si el precio del huevo es $31/kg y pones "Desde: 10kg, Descuento: $2", cuando un cliente compre 10kg o más, el precio será $29/kg.']})]})]}),e.jsx(J,{children:e.jsx(u,{onClick:R,className:"w-full h-12 rounded-2xl font-black uppercase","data-testid":"button-save-discount",children:"Guardar"})})]})})]})})}export{ue as default};
