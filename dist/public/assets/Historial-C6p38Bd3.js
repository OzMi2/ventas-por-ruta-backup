import{c as ce,a as ue,r as l,j as e}from"./index-jlwN39o6.js";import{A as me,B as xe}from"./AppShell-DqOjJXDS.js";import{C as b}from"./card-CRmQ0_oL.js";import{B as u,a as C,I as X}from"./offlineCache-DkBvSVfm.js";import{D as pe,a as he,b as fe,c as ge}from"./dialog-efzK4Gne.js";import{S as be,a as Ne,b as ve,c as je,d as _e}from"./select-BQzIMXLs.js";import{S as we}from"./SearchInput-BD5LiNf3.js";import{g as Y,F as Se,l as $e,a as De,b as ke}from"./historial-Bty6QgVx.js";import{P as ye,T as Ce,R as Ie}from"./TicketPrint-YotrE5ug.js";import{e as q}from"./exportExcel-CTcARCXR.js";import{D as Q}from"./download-BZGQDQAw.js";import"./search-FA93CoQI.js";const Re=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],Te=ce("chevron-right",Re);function Fe(x){const p=Number(x);return Number.isFinite(p)?p:0}function I(x){return`$${Fe(x).toFixed(2)}`}function Me(x){try{const p=new Date(x);return p.toLocaleDateString()+" "+p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return x}}function Xe(){const{state:x}=ue(),p=x.session?.rol,R=p==="admin"||p==="auditor",[N,J]=l.useState([]),[h,W]=l.useState(""),[A,ee]=l.useState(""),[te,P]=l.useState(!1),[ae,se]=l.useState([]),[E,V]=l.useState(!1),[ne,z]=l.useState(!1),[T,L]=l.useState(null),[oe,H]=l.useState(null),[K,B]=l.useState(null),[o,v]=l.useState(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}),[r,j]=l.useState(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}),[re,G]=l.useState(!1);function $(t){const a=new Date,n=i=>`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`;if(t==="hoy")v(n(a)),j(n(a));else if(t==="semana"){const i=new Date(a);i.setDate(i.getDate()-7),v(n(i)),j(n(a))}else if(t==="mes"){const i=new Date(a);i.setDate(i.getDate()-30),v(n(i)),j(n(a))}else v(""),j("")}async function de(){const t=await $e();t.sort((a,n)=>{const i=parseInt(a.nombre.replace(/\D/g,""))||0,w=parseInt(n.nombre.replace(/\D/g,""))||0;return i-w}),J(t)}async function O(){if(h){P(!0);try{const t=await De({rutaId:h});se(t)}finally{P(!1)}}}l.useEffect(()=>{de()},[]),l.useEffect(()=>{O()},[h]);const D=ae.filter(t=>t.cliente_nombre.toLowerCase().includes(A.trim().toLowerCase())),Z=t=>{const a=new Date(t.fecha_iso),n=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`;return o&&r?n>=o&&n<=r:o?n>=o:r?n<=r:!0},U=l.useMemo(()=>D.map(t=>({...t,ventasFiltradas:t.ventas.filter(Z)})).filter(t=>t.ventasFiltradas.length>0),[D,o,r]),_=l.useMemo(()=>{const t=[];for(const a of D)for(const n of a.ventas)Z(n)&&t.push({...n,cliente_nombre:n.cliente_nombre||a.cliente_nombre||"",cliente_id:n.cliente_id||a.cliente_id||""});return t.sort((a,n)=>new Date(n.fecha_iso).getTime()-new Date(a.fecha_iso).getTime())},[D,o,r]),k=N.find(t=>t.id===h)?.nombre||"";async function ie(){if(!(!R||N.length===0)){V(!0);try{const t=await ke({fechaDesde:o||void 0,fechaHasta:r||void 0}),a=[],n=[];for(const s of N){const m=await Y(Number(s.id),o||void 0,r||void 0);a.push(...m);const S=localStorage.getItem("auth_token");try{const f=await fetch(`/api/inventario/ruta/${s.id}`,{headers:{Authorization:`Bearer ${S}`}});if(f.ok){const g=await f.json();for(const c of g.inventarioMixto||[])n.push({rutaNombre:s.nombre,productoId:c.productoId,productoNombre:c.productoNombre||"",piezas:Number(c.cantidadPiezas)||0,kg:Number(c.cantidadKg)||0,unidad:"MIXTO"});for(const c of g.inventario||[]){const y=(g.productos||[]).find(le=>le.id===c.productoId)?.unidad||c.productoUnidad||"PIEZA";y!=="MIXTO"&&n.push({rutaNombre:s.nombre,productoId:c.productoId,productoNombre:c.productoNombre||"",piezas:y==="KG"?0:Number(c.cantidad)||0,kg:y==="KG"&&Number(c.cantidad)||0,unidad:y})}}}catch(f){console.error("Error fetching inventario ruta:",f)}}const i=o&&r?o===r?o:`${o}_a_${r}`:"todas",[{productos:w},{rules:F}]=await Promise.all([C.getProductos(),C.getDescuentos()]),M=(w||[]).map(s=>({id:s.id,nombre:s.nombre,precio:Number(s.precio)||0,unidad:s.unidad||"PIEZA"})),d=(F||[]).map(s=>({productoId:s.productoId,tiers:(s.tiers||[]).map(m=>({volumenDesde:Number(m.volumenDesde)||0,descuentoMonto:Number(m.descuentoMonto)||0}))}));q(t,`ventas_todas_rutas_${i}`,a,M,d,n)}finally{V(!1)}}}return e.jsx(me,{title:"Rutas · Historial",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsx(b,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground","data-testid":"text-historial-header",children:["Selecciona una ruta ",R&&e.jsx("span",{className:"ml-2 text-green-500",children:"(Admin)"})]}),e.jsx("div",{className:"text-sm font-bold","data-testid":"text-historial-route-selected",children:k||"—"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[R&&e.jsxs(e.Fragment,{children:[e.jsxs(u,{variant:"default",className:"h-10 rounded-2xl font-black uppercase text-[10px] gap-1 bg-green-600 hover:bg-green-700",onClick:ie,disabled:E||N.length===0,"data-testid":"button-exportar-todas-rutas",children:[e.jsx(Q,{className:"h-4 w-4"})," ",E?"Cargando...":"Excel Todas"]}),e.jsxs(u,{variant:"outline",className:"h-10 rounded-2xl font-black uppercase text-[10px] gap-1",onClick:async()=>{const t=o&&r?o===r?o:`${o}_a_${r}`:"todas",a=_.map(d=>({id:String(d.id),folio:String(d.id),fecha_iso:d.fecha_iso,ruta_nombre:k,cliente_id:String(d.cliente_id),cliente_nombre:d.cliente_nombre,vendedor_id:"",vendedor_nombre:"",tipo_pago:d.tipo_pago,total:Number(d.total)||0,descuentos:Number(d.descuentos)||0,abono:Number(d.abono)||0,items:(d.items||[]).map(s=>{const m=(s.unidad||s.tipo_venta||"PIEZA").toUpperCase(),S=Number(s.cantidad)||0,f=m==="MIXTO",g=m==="KG";return{productoId:Number(s.productoId)||Number(s.producto_id)||0,producto_id:Number(s.productoId)||Number(s.producto_id)||0,producto:s.producto||"",unidad:m,tipo_venta:m,cantidad:S,piezas:f?Number(s.piezas)||0:g?0:S,kilos:f?Number(s.kilos)||0:g?S:0,precio_unitario:Number(s.precio_unitario)||0,precioUnitario:Number(s.precio_unitario)||0,descuento_unitario:Number(s.descuento_unitario)||0,descuentoUnitario:Number(s.descuento_unitario)||0,subtotal:Number(s.subtotal)||0}})})),n=h?await Y(Number(h),o||void 0,r||void 0):[],[{productos:i},{rules:w}]=await Promise.all([C.getProductos(),C.getDescuentos()]),F=(i||[]).map(d=>({id:d.id,nombre:d.nombre,precio:Number(d.precio)||0,unidad:d.unidad||"PIEZA"})),M=(w||[]).map(d=>({productoId:d.productoId,tiers:(d.tiers||[]).map(s=>({volumenDesde:Number(s.volumenDesde)||0,descuentoMonto:Number(s.descuentoMonto)||0}))}));q(a,`ventas_${k}_${t}`,n,F,M)},disabled:_.length===0,"data-testid":"button-exportar-excel",children:[e.jsx(Q,{className:"h-4 w-4"})," Excel Ruta"]})]}),e.jsxs(u,{variant:"outline",className:"h-10 rounded-2xl font-black uppercase text-[10px] gap-1",onClick:()=>G(!0),disabled:_.length===0,"data-testid":"button-generar-reporte",children:[e.jsx(Se,{className:"h-4 w-4"})," Reporte"]}),e.jsx(u,{variant:"secondary",className:"h-10 rounded-2xl font-black uppercase text-[10px]",onClick:O,"data-testid":"button-refresh-historial",children:"Refrescar"})]})]}),e.jsxs(be,{value:h,onValueChange:W,children:[e.jsx(Ne,{className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-ruta",children:e.jsx(ve,{placeholder:"Seleccionar ruta..."})}),e.jsx(je,{className:"rounded-2xl max-h-[300px]",children:N.map(t=>e.jsx(_e,{value:t.id,className:"font-bold","data-testid":`option-ruta-${t.id}`,children:t.nombre},t.id))})]}),e.jsx(we,{value:A,onChange:ee,placeholder:"Buscar cliente...",testId:"search-historial-clientes"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.jsx(u,{variant:o===r&&o!==""?"default":"outline",size:"sm",className:"text-[10px] h-7 rounded-lg font-bold",onClick:()=>$("hoy"),children:"Hoy"}),e.jsx(u,{variant:"outline",size:"sm",className:"text-[10px] h-7 rounded-lg font-bold",onClick:()=>$("semana"),children:"7 días"}),e.jsx(u,{variant:"outline",size:"sm",className:"text-[10px] h-7 rounded-lg font-bold",onClick:()=>$("mes"),children:"30 días"}),e.jsx(u,{variant:!o&&!r?"default":"outline",size:"sm",className:"text-[10px] h-7 rounded-lg font-bold",onClick:()=>$("todas"),children:"Todas"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-muted-foreground font-bold",children:"Desde"}),e.jsx(X,{type:"date",value:o,onChange:t=>v(t.target.value),className:"h-10 pl-14 rounded-2xl bg-muted/30 border-none font-bold text-sm","data-testid":"input-fecha-desde"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-muted-foreground font-bold",children:"Hasta"}),e.jsx(X,{type:"date",value:r,onChange:t=>j(t.target.value),className:"h-10 pl-14 rounded-2xl bg-muted/30 border-none font-bold text-sm","data-testid":"input-fecha-hasta"})]})]}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"text-xs font-bold text-muted-foreground",children:["Ventas encontradas: ",e.jsx("span",{className:"text-primary",children:_.length})]})})]})}),e.jsx("div",{className:"grid gap-2",children:h?te?e.jsx(b,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center","data-testid":"loading-historial",children:e.jsx("div",{className:"text-xs font-bold text-muted-foreground uppercase",children:"Cargando…"})}):U.length===0?e.jsxs(b,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center","data-testid":"empty-historial",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin ventas"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"No hay ventas en el rango de fechas seleccionado."})]}):U.map(t=>e.jsx(b,{className:"p-4 rounded-2xl border-none shadow-sm bg-card/60 active:scale-[0.99] transition","data-testid":`card-historial-cliente-${t.cliente_id}`,onClick:()=>{L(t),z(!0)},children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-black truncate","data-testid":`text-historial-cliente-nombre-${t.cliente_id}`,children:t.cliente_nombre}),e.jsxs("div",{className:"mt-1 text-[11px] font-bold text-muted-foreground","data-testid":`text-historial-cliente-meta-${t.cliente_id}`,children:[t.ventasFiltradas.length," ventas · Saldo: ",t.saldo_actual!=null?I(t.saldo_actual):"—"]})]}),e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"})]})},t.cliente_id)):e.jsxs(b,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center","data-testid":"no-ruta-selected",children:[e.jsx("div",{className:"text-sm font-bold",children:"Selecciona una ruta"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"Elige una ruta del menú para ver el historial de clientes."})]})}),e.jsx(pe,{open:ne,onOpenChange:t=>{z(t),t||(H(null),L(null))},children:e.jsxs(he,{className:"max-w-[95%] sm:max-w-[520px] rounded-3xl",children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-sm font-black uppercase tracking-widest text-center","data-testid":"text-historial-cliente-dialog-title",children:T?.cliente_nombre||"Cliente"})}),e.jsx("div",{className:"grid gap-3 max-h-[70vh] overflow-y-auto px-1",children:(T?.ventasFiltradas||T?.ventas||[]).map(t=>e.jsxs(b,{className:"p-3 rounded-2xl border-none shadow-sm bg-muted/20","data-testid":`card-historial-venta-${t.id}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{variant:"secondary",className:"h-5 text-[9px] font-black uppercase","data-testid":`badge-historial-venta-${t.id}`,children:t.tipo_pago}),e.jsx("div",{className:"text-xs font-black","data-testid":`text-historial-venta-folio-${t.id}`,children:t.folio})]}),e.jsx("div",{className:"mt-1 text-[11px] font-bold text-muted-foreground","data-testid":`text-historial-venta-fecha-${t.id}`,children:Me(t.fecha_iso)}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-[11px] font-bold","data-testid":`text-historial-venta-total-${t.id}`,children:[e.jsx("span",{className:"text-muted-foreground",children:"Total:"}),e.jsx("span",{className:"text-primary",children:I(t.total)}),t.descuentos>0?e.jsxs("span",{className:"text-muted-foreground",children:["(dto -",I(t.descuentos),")"]}):null]}),t.vendedor_nombre&&e.jsxs("div",{className:"mt-1 text-[10px] font-bold text-muted-foreground","data-testid":`text-historial-venta-vendedor-${t.id}`,children:["Vendedor: ",e.jsx("span",{className:"text-foreground",children:t.vendedor_nombre})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(u,{variant:"secondary",size:"sm",className:"h-8 rounded-xl font-black uppercase text-[10px] gap-2",onClick:()=>B(t),"data-testid":`button-print-venta-${t.id}`,children:[e.jsx(ye,{className:"h-4 w-4"})," Imprimir"]}),e.jsx(u,{variant:"outline",size:"sm",className:"h-8 rounded-xl font-black uppercase text-[10px]",onClick:()=>H(t),"data-testid":`button-ver-detalle-venta-${t.id}`,children:"Ver"})]})]}),oe?.id===t.id?e.jsx("div",{className:"mt-3 grid gap-2","data-testid":`panel-venta-detalle-${t.id}`,children:(t.items||[]).map((a,n)=>{const i=a.unidad==="MIXTO"?`${a.piezas||a.cantidad} PZ + ${a.kilos.toFixed(2)} KG`:a.tipo_venta==="peso"||a.unidad==="KG"?`${a.kilos.toFixed(2)} KG`:`${a.cantidad} PZ`;return e.jsxs("div",{className:"flex justify-between text-[11px] font-bold","data-testid":`row-venta-item-${t.id}-${n}`,children:[e.jsx("span",{className:"truncate max-w-[220px]",children:a.producto}),e.jsx("span",{className:"text-muted-foreground",children:i}),e.jsx("span",{className:"text-primary",children:I(a.subtotal)})]},n)})}):null]},t.id))})]})}),e.jsx(Ce,{venta:K,open:!!K,onClose:()=>B(null)}),e.jsx(Ie,{ventas:_,fecha:o&&r?o===r?o:`${o} a ${r}`:"Todas las fechas",rutaNombre:k,open:re,onClose:()=>G(!1)})]})})}export{Xe as default};
