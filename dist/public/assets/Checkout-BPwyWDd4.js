import{a as be,b as fe,r as l,j as e}from"./index-C3FIjBsS.js";import{A as he,B as je,r as Ne}from"./AppShell-DP6dkc32.js";import{B as u,I as j}from"./offlineCache-DoXVbz4G.js";import{C as R}from"./card-D08MNxaG.js";import{A as te,b as se}from"./alert-Bjj-s_4Y.js";import{L as M}from"./label-DX9Kxc1C.js";import{D as O,a as z,b as V,c as B,d as ae}from"./dialog-DD5idXN4.js";import{P as ve,T as ke}from"./TicketPrint-B2gKWufy.js";import{T as _e}from"./trash-2-CkIFwAva.js";function s(a){const i=Number(a);return Number.isFinite(i)?i:0}function A(a){const i=s(a.precio_aplicado);return a.tipo_venta==="unidad"?s(a.cantidad)*i:s(a.kilos)*i}function we(a){const i=a.tipo_venta==="unidad"?s(a.cantidad):s(a.kilos);return s(a.discount_unit)*i}function De(){const{state:a,dispatch:i}=be(),{toast:ne}=fe(),L="efectivo",[f,re]=l.useState("0"),[T,oe]=l.useState(""),[p,ie]=l.useState(!1),[q,K]=l.useState(!1),[U,c]=l.useState(null),[N,v]=l.useState(null),[$,G]=l.useState(null),[ce,k]=l.useState(!1),[H,_]=l.useState(null),[de,w]=l.useState(!1),m=a.cart.reduce((t,n)=>t+A(n),0),E=a.cart.reduce((t,n)=>t+we(n),0),le=m+E,F=a.selectedClient?.saldo??null,C=s(F),W=m+C,P=W,D=s(T),Z=s(f),I=D>Z?D-Z:0;function ue(){if(c(null),!a.session){c("No hay sesión.");return}if(!a.selectedClient){c("Selecciona un cliente.");return}if(!p&&a.cart.length===0){c("El carrito está vacío.");return}const t=s(f);if(t<0){c("El abono no puede ser negativo.");return}if(t>P){c(`El abono no puede ser mayor a $${P.toFixed(2)} (compra + saldo pendiente).`);return}w(!0)}function xe(){w(!1);const t=s(f);if(!p&&t<m){const n=m-t;_({faltante:n});return}Q()}async function Q(){if(_(null),c(null),!a.session){c("No hay sesión.");return}if(!a.selectedClient){c("Selecciona un cliente.");return}if(!p&&a.cart.length===0){c("El carrito está vacío.");return}const t=s(f);if(t<0){c("El abono no puede ser negativo.");return}const n=s(T),x=n>t?n-t:0,g={usuario_id:a.session.usuario_id,cliente_id:a.selectedClient.id,ruta_id:a.session.rutaId,tipo_pago:L,abono_pago:t,pago_cliente:n,cambio:x,folio_ticket:null,items:p?[]:a.cart.map(r=>({producto_id:r.producto_id,cantidad:r.cantidad??0,kilos:r.kilos??0,precio_unitario:s(r.precio_base),descuento_unitario:s(r.discount_unit),subtotal:A(r)}))};K(!0);try{const r=await Ne(g);v(r);const y=new Date().toISOString();if(p){const b=a.session.rutaId||a.selectedClient?.rutaId||"",S={id:`ticket_abono_${Date.now()}`,folio:String(r?.folio_ticket||"—"),fecha_iso:y,ruta:String(b),ruta_nombre:String(b),cliente_id:String(a.selectedClient?.id||""),cliente_nombre:String(a.selectedClient?.nombre||""),vendedor_id:String(a.session.usuario_id),vendedor_nombre:String(a.session.nombre||""),tipo_pago:"abono",subtotal_base:0,descuentos:0,total:0,abono:s(t),saldo_anterior:s(r?.saldo_anterior??F),saldo_final:s(r?.saldo_final),items:[{producto:"ABONO",tipo_venta:"unidad",cantidad:1,kilos:0,precio_unitario:s(t),descuento_unitario:0,subtotal:s(t)}]};G(S),k(!0)}else{const b=a.cart.map(o=>{const d=o.requiere_piezas,h=o.tipo_venta==="unidad"?s(o.cantidad):s(o.kilos),Y=s(o.precio_base),ee=s(o.discount_unit),ge=Math.max(Y-ee,0);return{producto:o.nombre,tipo_venta:o.tipo_venta,unidad:d?"MIXTO":o.tipo_venta==="unidad"?"PIEZA":"KG",cantidad:s(o.cantidad),piezas:d||o.tipo_venta==="unidad"?s(o.cantidad):0,kilos:s(o.kilos),precio_unitario:Y,descuento_unitario:ee,subtotal:h*ge}}),S=b.reduce((o,d)=>{const h=d.tipo_venta==="unidad"?s(d.cantidad):s(d.kilos);return o+h*s(d.precio_unitario)},0),X=b.reduce((o,d)=>{const h=d.tipo_venta==="unidad"?s(d.cantidad):s(d.kilos);return o+h*s(d.descuento_unitario)},0),pe=S-X,J=a.session.rutaId||a.selectedClient?.rutaId||"",me={id:`ticket_${Date.now()}`,folio:String(r?.folio_ticket||"—"),fecha_iso:y,ruta:String(J),ruta_nombre:String(J),cliente_id:String(a.selectedClient?.id||""),cliente_nombre:String(a.selectedClient?.nombre||""),vendedor_id:String(a.session.usuario_id),vendedor_nombre:String(a.session.nombre||""),tipo_pago:String(L),subtotal_base:s(S),descuentos:s(X),total:s(pe),abono:s(t),saldo_anterior:s(r?.saldo_anterior??F),saldo_final:s(r?.saldo_final),pago_cliente:D,cambio:I,items:b};G(me)}ne({title:"Enviado",description:"Venta registrada."}),i({type:"CART_CLEAR"}),i({type:"CLIENT_SET",client:null})}catch(r){c(r?.message||"Error al registrar.")}finally{K(!1)}}return e.jsx(he,{title:"Checkout",children:e.jsxs("div",{className:"grid gap-4 pb-24",children:[!a.selectedClient&&e.jsx(te,{variant:"destructive",className:"rounded-2xl border-none bg-destructive/10 text-destructive",children:e.jsx(se,{className:"font-bold",children:"Selecciona un cliente para continuar."})}),U&&e.jsx(te,{variant:"destructive",className:"rounded-2xl border-none bg-destructive/10 text-destructive",children:e.jsx(se,{className:"font-bold",children:U})}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 px-1",children:[e.jsx("h2",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground",children:"Productos"}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>i({type:"CART_CLEAR"}),disabled:a.cart.length===0,className:"h-7 text-[10px] font-black uppercase",children:"Vaciar"})]}),e.jsx("div",{className:"grid gap-2",children:a.cart.length===0?e.jsx(R,{className:"p-8 text-center rounded-3xl bg-muted/20 border-dashed",children:e.jsx("div",{className:"text-xs font-bold text-muted-foreground uppercase",children:"Tu carrito está vacío"})}):a.cart.map((t,n)=>e.jsxs(R,{className:"p-3 shadow-sm border-none bg-card/60 rounded-2xl","data-testid":`card-cart-item-${n}`,children:[e.jsxs("div",{className:"flex justify-between items-start gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-bold truncate",children:t.nombre}),e.jsxs("div",{className:"mt-0.5 flex flex-wrap gap-x-2 text-[10px] font-bold",children:[s(t.discount_unit)>0&&e.jsxs("span",{className:"text-muted-foreground line-through decoration-destructive/50",children:["$",s(t.precio_base).toFixed(2)]}),e.jsxs("span",{className:"text-primary",children:["$",s(t.precio_aplicado).toFixed(2)," ",t.tipo_venta==="unidad"?"PZ":"KG"]}),s(t.discount_unit)>0&&e.jsxs(je,{variant:"secondary",className:"h-4 text-[8px] bg-primary/10 text-primary border-none px-1 uppercase",children:["-$",s(t.discount_unit)," DTO"]})]})]}),e.jsx(u,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground",onClick:()=>i({type:"CART_REMOVE",index:n}),children:e.jsx(_e,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.tipo_venta==="unidad"?e.jsx(j,{className:"h-9 rounded-xl bg-background border-none text-center font-bold text-sm",inputMode:"numeric",value:String(t.cantidad??0),onChange:x=>i({type:"CART_UPDATE",index:n,patch:{cantidad:s(x.target.value)}})}):e.jsxs("div",{className:"flex flex-1 gap-2",children:[e.jsx(j,{className:"h-9 rounded-xl bg-background border-none text-center font-bold text-sm",inputMode:"decimal",value:String(t.kilos??0),onChange:x=>i({type:"CART_UPDATE",index:n,patch:{kilos:s(x.target.value)}})}),t.requiere_piezas&&e.jsx(j,{className:"h-9 rounded-xl bg-background border-none text-center font-bold text-sm",inputMode:"numeric",value:String(t.cantidad??0),onChange:x=>i({type:"CART_UPDATE",index:n,patch:{cantidad:s(x.target.value)}})})]}),e.jsxs("div",{className:"min-w-[60px] text-right text-sm font-black text-primary",children:["$",A(t).toFixed(2)]})]})]},`${t.producto_id}-${n}`))})]}),e.jsxs("section",{className:"grid gap-2",children:[e.jsx("h2",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground px-1",children:"Resumen y Pago"}),e.jsx(R,{className:"p-4 shadow-xl border-none bg-card rounded-3xl",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex justify-between items-center text-muted-foreground",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Subtotal Base"}),e.jsxs("span",{className:"text-sm font-bold",children:["$",le.toFixed(2)]})]}),E>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center text-primary",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Descuentos"}),e.jsxs("span",{className:"text-sm font-bold",children:["-$",E.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center p-3 rounded-2xl bg-green-500/10 border border-green-500/30",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-green-600",children:"Total con Descuentos"}),e.jsxs("span",{className:"text-lg font-black text-green-600",children:["$",m.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-between items-center text-muted-foreground",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Saldo Anterior"}),e.jsx("span",{className:"text-sm font-bold",children:C>0?`$${C.toFixed(2)}`:"—"})]}),C>0&&e.jsxs("div",{className:"flex justify-between items-center p-3 rounded-2xl bg-amber-500/10 border border-amber-500/30",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-amber-600",children:"Total con Saldo"}),e.jsxs("span",{className:"text-lg font-black text-amber-600",children:["$",W.toFixed(2)]})]}),e.jsx("div",{className:"border-b border-dashed pb-3"}),e.jsxs("div",{className:"grid gap-4 mt-2",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsxs(M,{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1",children:["Abono del Cliente (máx: $",P.toFixed(2),")"]}),e.jsx(j,{className:"h-12 rounded-2xl bg-muted/30 border-none text-lg font-black text-center",inputMode:"decimal",value:f,onChange:t=>re(t.target.value)})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(M,{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1",children:"Cliente pagó con"}),e.jsx(j,{className:"h-12 rounded-2xl bg-muted/30 border-none text-lg font-black text-center",inputMode:"decimal",placeholder:"$0.00",value:T,onChange:t=>oe(t.target.value)})]}),I>0&&e.jsxs("div",{className:"flex justify-between items-center p-3 rounded-2xl bg-green-500/10 border border-green-500/30",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-green-600",children:"Cambio"}),e.jsxs("span",{className:"text-xl font-black text-green-600",children:["$",I.toFixed(2)]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(M,{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1",children:"Método de Pago"}),e.jsx("div",{className:"h-12 rounded-2xl bg-muted/30 border-none font-bold uppercase text-xs tracking-widest flex items-center justify-center",children:"EFECTIVO"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-2xl bg-muted/20 border border-muted",children:[e.jsxs("div",{className:"grid",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-tighter",children:"Solo Abono"}),e.jsx("span",{className:"text-[9px] font-bold text-muted-foreground uppercase leading-none",children:"Sin compra"})]}),e.jsx(u,{variant:p?"default":"secondary",size:"sm",className:"rounded-full font-black uppercase text-[10px] h-7",onClick:()=>ie(!p),children:p?"SÍ":"NO"})]})]}),e.jsxs("div",{className:"mt-4 flex justify-between items-center p-4 rounded-2xl bg-primary text-primary-foreground shadow-lg shadow-primary/20",children:[e.jsxs("div",{className:"grid",children:[e.jsx("span",{className:"text-[9px] font-black uppercase tracking-widest opacity-80",children:"Total a Cobrar"}),e.jsxs("span",{className:"text-2xl font-black tracking-tighter",children:["$",m.toFixed(2)]})]}),e.jsx(u,{onClick:ue,disabled:q,className:"rounded-xl h-12 bg-white text-primary hover:bg-white/90 font-black uppercase px-6",children:q?"...":"Enviar"})]})]})})]})]}),e.jsx(O,{open:de,onOpenChange:t=>!t&&w(!1),children:e.jsxs(z,{className:"max-w-[90%] rounded-3xl","data-testid":"modal-review-confirm",children:[e.jsx(V,{children:e.jsx(B,{className:"text-center font-black uppercase text-primary",children:"Confirmar Venta"})}),e.jsxs("div",{className:"grid gap-3 py-4",children:[e.jsx("div",{className:"text-center text-lg font-bold",children:"¿Has revisado el carrito?"}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground mb-2",children:[a.cart.length," producto(s) · Total: $",m.toFixed(2)]}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded-lg p-2 bg-muted/30",children:a.cart.map((t,n)=>{const x=t.tipo_venta||"unidad";let g="";if(t.requiere_piezas&&t.kilos){const r=t.cantidad||0,y=t.kilos||0;g=`${r} Pzas / ${y.toFixed(2)} Kg`}else x==="peso"?g=`${(t.kilos||0).toFixed(2)} Kg`:g=`${t.cantidad||0} Pzas`;return e.jsxs("div",{className:"flex justify-between text-xs py-1 border-b last:border-0",children:[e.jsx("span",{className:"font-medium",children:t.nombre||"Producto"}),e.jsxs("span",{className:"text-muted-foreground",children:[g," · $",A(t).toFixed(2)]})]},n)})})]}),e.jsxs(ae,{className:"grid grid-cols-2 gap-2",children:[e.jsx(u,{variant:"outline",className:"rounded-2xl font-black uppercase",onClick:()=>w(!1),"data-testid":"button-review-no",children:"No, revisar"}),e.jsx(u,{className:"rounded-2xl font-black uppercase",onClick:xe,"data-testid":"button-review-yes",children:"Sí, enviar"})]})]})}),e.jsx(O,{open:!!H,onOpenChange:t=>!t&&_(null),children:e.jsxs(z,{className:"max-w-[90%] rounded-3xl","data-testid":"modal-credit-warning",children:[e.jsx(V,{children:e.jsx(B,{className:"text-center font-black uppercase text-destructive",children:"Advertencia"})}),e.jsxs("div",{className:"grid gap-3 py-4",children:[e.jsx("div",{className:"text-center text-sm font-bold",children:"El cliente le falta por pagar:"}),e.jsxs("div",{className:"text-center text-2xl font-black text-destructive",children:["$",H?.faltante.toFixed(2)]}),e.jsx("div",{className:"text-center text-xs font-bold text-muted-foreground",children:"¿Agregar este monto a crédito?"})]}),e.jsxs(ae,{className:"grid grid-cols-2 gap-2",children:[e.jsx(u,{variant:"outline",className:"rounded-2xl font-black uppercase",onClick:()=>_(null),"data-testid":"button-cancel-credit",children:"Cancelar"}),e.jsx(u,{variant:"destructive",className:"rounded-2xl font-black uppercase",onClick:Q,"data-testid":"button-confirm-credit",children:"Sí, a crédito"})]})]})}),e.jsx(O,{open:!!N,onOpenChange:t=>!t&&v(null),children:e.jsxs(z,{className:"max-w-[90%] rounded-3xl","data-testid":"modal-confirmacion",children:[e.jsx(V,{children:e.jsx(B,{className:"text-center font-black uppercase",children:"¡Registro Exitoso!"})}),e.jsxs("div",{className:"grid gap-3 py-4",children:[e.jsxs("div",{className:"flex justify-between items-center text-xs font-bold uppercase tracking-tighter text-muted-foreground border-b border-dashed pb-2",children:[e.jsx("span",{children:"Folio"}),e.jsx("span",{className:"text-foreground",children:N?.folio_ticket||"—"})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm font-black uppercase",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{className:"text-primary",children:["$",s(N?.total_ticket).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center text-[11px] font-bold uppercase text-muted-foreground",children:[e.jsx("span",{children:"Saldo Final"}),e.jsxs("span",{className:"text-foreground",children:["$",s(N?.saldo_final).toFixed(2)]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(u,{variant:"secondary",className:"w-full h-12 rounded-2xl font-black uppercase tracking-widest gap-2",disabled:!$,onClick:()=>{k(!0),v(null)},"data-testid":"button-print-last-ticket",children:[e.jsx(ve,{className:"h-4 w-4"})," Imprimir ticket"]}),e.jsx(u,{className:"w-full h-12 rounded-2xl font-black uppercase tracking-widest",onClick:()=>v(null),"data-testid":"button-close-confirm",children:"Entendido"})]})]})}),e.jsx(ke,{venta:$,open:ce,onClose:()=>k(!1),isAbono:$?.tipo_pago==="abono",onVolver:()=>{k(!1),window.location.href="/"}})]})})}export{De as default};
