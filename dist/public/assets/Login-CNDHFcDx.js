import{u as C,a as P,b as A,r as n,j as e}from"./index-DB2cU-Bb.js";import{C as I,a as E,b as k,c as T}from"./card-DhoJ9o-_.js";import{a as v,s as $,I as j,B}from"./offlineCache-DJaRb9T9.js";import{A as D,a as L,b as _}from"./alert-Bfcr2j4j.js";import{f as F}from"./discounts-Dhl_U5KD.js";async function U({usuario:s,password:t}){const a=await v.login(s,t);return{ok:!0,usuario_id:a.usuario.id,rol:a.usuario.rol,nombre:a.usuario.nombre,token:a.token,rutaId:a.usuario.rutaId}}async function z(){const s=[];try{const t=await v.bootstrap();$(t),console.log("[Precache] Bootstrap data cached")}catch(t){s.push(`Bootstrap: ${t.message}`)}try{const t=await F();console.log(`[Precache] ${t.length} descuentos cargados`)}catch(t){s.push(`Descuentos: ${t.message}`)}return{success:s.length===0,errors:s}}async function G(){if("serviceWorker"in navigator&&navigator.serviceWorker.controller)try{const t=await(await fetch("/")).text(),a=t.match(/\/assets\/[^"']+\.js/g)||[],l=t.match(/\/assets\/[^"']+\.css/g)||[],i=Array.from(new Set([...a,...l])),d=i.map(async r=>{try{await fetch(r),console.log(`[Precache] Asset cached: ${r}`)}catch{console.warn(`[Precache] Failed to cache: ${r}`)}});await Promise.all(d),console.log(`[Precache] ${i.length} assets cached`)}catch(s){console.warn("[Precache] Asset precaching failed:",s)}try{await fetch("/manifest.json"),await fetch("/favicon.png"),await fetch("/icons/icon-192x192.png"),await fetch("/icons/icon-512x512.png"),console.log("[Precache] Static assets cached")}catch(s){console.warn("[Precache] Static assets failed:",s)}}async function M(s){s?.("Descargando datos..."),await z(),s?.("Cacheando aplicación..."),await G(),s?.("¡Listo para usar offline!")}function q(){const[,s]=C(),{dispatch:t,state:a}=P(),{toast:l}=A(),[i,d]=n.useState(""),[r,p]=n.useState(""),[m,x]=n.useState(!1),[u,g]=n.useState(!1),[y,f]=n.useState(""),[w,h]=n.useState(null);n.useEffect(()=>{a.session&&s("/clientes")},[a.session,s]);async function N(c){if(c.preventDefault(),h(null),!i.trim()||!r.trim()){h("Ingresa usuario y contraseña.");return}x(!0);try{const o=await U({usuario:i.trim(),password:r.trim()}),b={usuario_id:o.usuario_id.toString(),rol:o.rol,nombre:o.nombre,token:o.token,rutaId:o.rutaId};t({type:"SESSION_SET",session:b}),l({title:"Sesión iniciada",description:`Bienvenido/a ${b.nombre}`.trim()}),g(!0),f("Preparando app para uso offline..."),M(S=>f(S)).then(()=>{l({title:"App lista",description:"Todos los datos están cacheados para uso offline"})}).catch(()=>{}).finally(()=>{g(!1),s("/clientes")})}catch(o){h(o?.message||"No se pudo iniciar sesión.")}finally{x(!1)}}return e.jsx("div",{className:"min-h-svh grid place-items-center p-6 app-noise app-grid",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsxs("div",{className:"mb-6 text-center",children:[e.jsx("div",{className:"mx-auto mb-3 grid h-12 w-12 place-items-center rounded-2xl bg-primary text-primary-foreground shadow-md",children:e.jsx("span",{className:"text-sm font-semibold",children:"GS"})}),e.jsx("h1",{className:"text-2xl font-semibold tracking-tight","data-testid":"text-login-title",children:"Garlo's Sistema de Ventas"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground","data-testid":"text-login-subtitle",children:"Soluciones rápidas, ventas rápidas"})]}),e.jsxs(I,{className:"shadow-md",children:[e.jsx(E,{children:e.jsx(k,{children:"Iniciar sesión"})}),e.jsxs(T,{children:[w?e.jsxs(D,{variant:"destructive",className:"mb-4","data-testid":"alert-login-error",children:[e.jsx(L,{children:"Error"}),e.jsx(_,{"data-testid":"text-login-error",children:w})]}):null,e.jsxs("form",{onSubmit:N,className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-xs font-bold uppercase tracking-wider text-muted-foreground",htmlFor:"usuario",children:"Usuario"}),e.jsx(j,{id:"usuario",className:"h-12 text-base rounded-xl",value:i,onChange:c=>d(c.target.value),placeholder:"Ej. vendedor01",autoComplete:"username","data-testid":"input-usuario"})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-xs font-bold uppercase tracking-wider text-muted-foreground",htmlFor:"password",children:"Contraseña"}),e.jsx(j,{id:"password",className:"h-12 text-base rounded-xl",type:"password",value:r,onChange:c=>p(c.target.value),placeholder:"••••••••",autoComplete:"current-password","data-testid":"input-password"})]}),e.jsx(B,{type:"submit",size:"lg",className:"h-12 rounded-xl text-base font-bold shadow-lg shadow-primary/20",disabled:m||u,"data-testid":"button-login",children:m?"Entrando...":u?"Cargando datos...":"Iniciar Sesión"}),u&&e.jsxs("div",{className:"mt-2 p-3 rounded-xl bg-primary/10 text-center animate-pulse",children:[e.jsx("div",{className:"text-xs font-bold text-primary",children:y}),e.jsx("div",{className:"mt-1 text-[10px] text-muted-foreground",children:"Esto solo ocurre una vez"})]}),e.jsx("div",{className:"mt-2 text-xs text-muted-foreground","data-testid":"text-login-hint",children:'Tip: configura la URL del API (IP/puerto) en "Configuración" si no es la predeterminada.'})]})]})]})]})})}export{q as default};
