import{c as W,b as Y,a as Z,r as o,j as e}from"./index-tJdYnMtm.js";import{A as ee,D as te}from"./AppShell-Dh3B1jwu.js";import{C as u}from"./card-hPFAobI0.js";import{I as B,B as N}from"./offlineCache-CkDYb09Y.js";import{L as v}from"./label-CjcTf4zn.js";import{S as se,a as ae,b as oe,c as ne,d as re}from"./select-BLjs4uxV.js";import{S as le}from"./skeleton-CNPulbRX.js";import{b as ie}from"./exportExcel-CTcARCXR.js";import{T as de}from"./TicketPrint-BqnlsLbI.js";import{U as L}from"./user-BHslG--k.js";import{C as ce}from"./circle-check-big-DTM-2EoQ.js";import{D as me}from"./download-4212kWnk.js";import"./dialog--ekzEc0F.js";const xe=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],ue=W("history",xe);function Ae(){const{toast:c}=Y(),{state:h}=Z(),S=h.session?.rol,R=S==="admin"||S==="auditor",[z,k]=o.useState(!1),[w,y]=o.useState(!1),[F,H]=o.useState([]),[a,O]=o.useState(""),[n,A]=o.useState(""),[$,_]=o.useState(""),[i,C]=o.useState(null),[p,E]=o.useState([]),[f,P]=o.useState(!1),[V,U]=o.useState(null),[q,b]=o.useState(!1),d=F.find(t=>t.id.toString()===a),J=async()=>{k(!0);try{const t=localStorage.getItem("auth_token"),s=await fetch("/api/clientes",{headers:{Authorization:`Bearer ${t}`}});if(s.ok){const r=((await s.json()).clientes||[]).filter(m=>parseFloat(m.saldo||"0")>0);H(r)}}catch(t){console.error("Error cargando clientes:",t)}finally{k(!1)}},I=async t=>{try{const s=localStorage.getItem("auth_token"),l=await fetch(`/api/saldos/${t}`,{headers:{Authorization:`Bearer ${s}`}});if(l.ok){const r=await l.json();C(r.saldo)}}catch(s){console.error("Error cargando saldo:",s)}},T=async t=>{try{const s=localStorage.getItem("auth_token"),l=await fetch(`/api/abonos/${t}`,{headers:{Authorization:`Bearer ${s}`}});if(l.ok){const r=await l.json();E(r.abonos||[])}}catch(s){console.error("Error cargando historial:",s)}};o.useEffect(()=>{J()},[]),o.useEffect(()=>{a?(I(a),T(a)):(C(null),E([]))},[a]);const X=async t=>{if(t.preventDefault(),!a||!n||parseFloat(n)<=0){c({title:"Validación",description:"Selecciona un cliente e ingresa un monto válido.",variant:"destructive"});return}const s=parseFloat(i||"0"),l=parseFloat(n);if(s<=0){c({title:"Sin saldo pendiente",description:"Este cliente no tiene saldo pendiente.",variant:"destructive"});return}if(l>s){c({title:"Monto excedido",description:`El monto máximo es $${s.toFixed(2)} (saldo actual del cliente).`,variant:"destructive"});return}y(!0);try{const r=localStorage.getItem("auth_token"),m=await fetch("/api/abonos",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({clienteId:parseInt(a),monto:parseFloat(n),notas:$.trim()||void 0})});if(!m.ok){const Q=await m.json();throw new Error(Q.error||"Error al registrar abono")}const x=await m.json(),M=h.session?.rutaId||"",K={id:`ticket_abono_${Date.now()}`,folio:String(x.abono?.id||"—"),fecha_iso:new Date().toISOString(),ruta:String(M),ruta_nombre:String(M),cliente_id:String(a),cliente_nombre:String(d?.nombre||""),vendedor_id:String(h.session?.usuario_id||""),vendedor_nombre:String(h.session?.nombre||""),tipo_pago:"abono",subtotal_base:0,descuentos:0,total:0,abono:parseFloat(n),saldo_anterior:parseFloat(x.abono.saldoAnterior||i||"0"),saldo_final:parseFloat(x.abono.saldoNuevo),items:[{producto:"ABONO",tipo_venta:"unidad",cantidad:1,kilos:0,precio_unitario:parseFloat(n),descuento_unitario:0,subtotal:parseFloat(n)}]};U(K),b(!0),c({title:"Abono Registrado",description:`Se registró un abono de $${parseFloat(n).toFixed(2)} para ${d?.nombre}. Nuevo saldo: $${x.abono.saldoNuevo}`}),A(""),_(""),I(a),T(a)}catch(r){c({title:"Error",description:r.message,variant:"destructive"})}finally{y(!1)}},G=t=>{try{return new Date(t).toLocaleDateString("es-MX",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return t}},g=parseFloat(i||"0"),j=parseFloat(n||"0"),D=g-j;return e.jsxs(ee,{title:"Abonos / Pagos",children:[e.jsxs("div",{className:"grid gap-6 pb-20",children:[e.jsxs(u,{className:"p-6 rounded-3xl border-none shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"grid h-12 w-12 place-items-center rounded-2xl bg-green-500/10",children:e.jsx(te,{className:"h-6 w-6 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-black",children:"Registrar Abono"}),e.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Recibir pago de cliente a cuenta"})]})]}),e.jsxs("form",{onSubmit:X,className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(v,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Cliente"}),e.jsxs(se,{value:a,onValueChange:O,children:[e.jsx(ae,{className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-cliente",children:e.jsx(oe,{placeholder:"Seleccionar cliente..."})}),e.jsx(ne,{className:"rounded-2xl max-h-60",children:z?e.jsx("div",{className:"p-4",children:e.jsx(le,{className:"h-4 w-full"})}):F.map(t=>e.jsx(re,{value:t.id.toString(),className:"font-bold",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:t.nombre})]})},t.id))})]})]}),d&&i!==null&&e.jsx(u,{className:`p-4 rounded-2xl ${g>0?"bg-red-500/5 border-red-500/20":"bg-green-500/5 border-green-500/20"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-black text-muted-foreground",children:"Cliente"}),e.jsx("div",{className:"text-sm font-bold",children:d.nombre})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs font-black text-muted-foreground",children:"Saldo Actual"}),e.jsxs("div",{className:`text-lg font-black ${g>0?"text-red-600":"text-green-600"}`,children:["$",parseFloat(i).toFixed(2)]})]})]})}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(v,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Monto del Abono"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-lg font-bold text-muted-foreground",children:"$"}),e.jsx(B,{type:"number",step:"0.01",min:"0",value:n,onChange:t=>A(t.target.value),placeholder:"0.00",className:"h-14 rounded-2xl bg-muted/30 border-none font-bold text-xl text-center pl-8","data-testid":"input-monto"})]})]}),j>0&&i!==null&&e.jsx(u,{className:"p-4 rounded-2xl bg-primary/5 border-primary/20",children:e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] font-black text-muted-foreground uppercase",children:"Anterior"}),e.jsxs("div",{className:"text-sm font-bold text-red-600",children:["$",g.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] font-black text-muted-foreground uppercase",children:"Abono"}),e.jsxs("div",{className:"text-sm font-bold text-green-600",children:["-$",j.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] font-black text-muted-foreground uppercase",children:"Nuevo"}),e.jsxs("div",{className:`text-sm font-bold ${D>0?"text-red-600":"text-green-600"}`,children:["$",D.toFixed(2)]})]})]})}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(v,{className:"text-[10px] font-black uppercase ml-1 text-muted-foreground",children:"Notas (opcional)"}),e.jsx(B,{value:$,onChange:t=>_(t.target.value),placeholder:"Ej: Pago en efectivo",className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"input-notas"})]}),e.jsx(N,{type:"submit",disabled:w||!a||!n||parseFloat(n)<=0,className:"h-14 rounded-2xl font-black uppercase text-sm mt-2","data-testid":"button-submit",children:w?"Registrando...":e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"h-5 w-5 mr-2"}),"Registrar Abono"]})})]})]}),a&&e.jsxs(u,{className:"p-6 rounded-3xl border-none shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"grid h-10 w-10 place-items-center rounded-xl bg-blue-500/10",children:e.jsx(ue,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-black",children:"Historial de Abonos"}),e.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:d?.nombre})]})]}),e.jsxs("div",{className:"flex gap-2",children:[p.length>0&&R&&e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>ie(p,d?.nombre||"cliente"),className:"text-xs font-bold gap-1","data-testid":"button-exportar-abonos",children:[e.jsx(me,{className:"h-3 w-3"})," Excel"]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>P(!f),className:"text-xs font-bold",children:f?"Ocultar":"Mostrar"})]})]}),f&&e.jsx("div",{className:"grid gap-2",children:p.length===0?e.jsx("div",{className:"text-center py-6 text-sm text-muted-foreground font-medium",children:"No hay abonos registrados"}):p.map(t=>e.jsx(u,{className:"p-3 rounded-2xl bg-muted/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-bold text-green-600",children:["+$",parseFloat(t.monto).toFixed(2)]}),e.jsxs("div",{className:"text-[10px] text-muted-foreground font-medium",children:[G(t.fecha)," · ",t.usuarioNombre]}),t.notas&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:t.notas})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Saldo"}),e.jsxs("div",{className:"text-xs font-bold",children:[e.jsxs("span",{className:"text-red-500",children:["$",parseFloat(t.saldoAnterior).toFixed(2)]}),e.jsx("span",{className:"mx-1",children:"→"}),e.jsxs("span",{className:parseFloat(t.saldoNuevo)>0?"text-red-500":"text-green-500",children:["$",parseFloat(t.saldoNuevo).toFixed(2)]})]})]})]})},t.id))})]})]}),e.jsx(de,{venta:V,open:q,onClose:()=>b(!1),isAbono:!0,onVolver:()=>{b(!1),window.location.href="/"}})]})}export{Ae as default};
