import{c as T,b as X,r as s,j as e,X as Q}from"./index-C3FIjBsS.js";import{A as W,P as Y}from"./AppShell-DP6dkc32.js";import{C as i}from"./card-D08MNxaG.js";import{B as p,I as h}from"./offlineCache-DoXVbz4G.js";import{S as Z,a as ee,b as te,c as ae,d as se}from"./select-CB6tcY6P.js";import{D as oe,a as re,b as ne,c as de,e as ie}from"./dialog-DD5idXN4.js";import{S as ce}from"./SearchInput-SskM3Udo.js";import"./search-BqS688Ky.js";const le=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],ue=T("save",le);const xe=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],D=T("square-pen",xe);function Ne(){const{toast:g}=X(),[B,j]=s.useState(!1),[N,G]=s.useState([]),[r,_]=s.useState(""),[A,k]=s.useState([]),[R,S]=s.useState([]),[f,L]=s.useState(""),[a,y]=s.useState(null),[w,c]=s.useState(""),[I,l]=s.useState(""),[z,u]=s.useState(""),[x,v]=s.useState(""),[C,E]=s.useState(!1),U=async()=>{try{const t=localStorage.getItem("auth_token"),o=await fetch("/api/rutas",{headers:{Authorization:`Bearer ${t}`}});if(o.ok){const n=((await o.json()).rutas||[]).sort((H,V)=>{const J=parseInt(H.nombre.replace(/\D/g,""))||0,q=parseInt(V.nombre.replace(/\D/g,""))||0;return J-q});G(n)}}catch(t){console.error("Error cargando rutas:",t)}},P=async t=>{if(!t){k([]),S([]);return}j(!0);try{const o=localStorage.getItem("auth_token"),d=await fetch(`/api/inventario/ruta/${t}`,{headers:{Authorization:`Bearer ${o}`}});if(d.ok){const n=await d.json();k(n.inventario||[]),S(n.inventarioMixto||[])}else g({title:"Error",description:"No se pudo cargar el inventario",variant:"destructive"})}catch(o){console.error("Error cargando inventario:",o)}finally{j(!1)}};s.useEffect(()=>{U()},[]),s.useEffect(()=>{P(r)},[r]);const F=N.find(t=>t.id.toString()===r)?.nombre||"",$=A.filter(t=>t.productoNombre.toLowerCase().includes(f.toLowerCase())),M=R.filter(t=>t.productoNombre.toLowerCase().includes(f.toLowerCase())),m=t=>"cantidadPiezas"in t,K=t=>{y(t),m(t)?(l(t.cantidadPiezas||"0"),u(t.cantidadKg||"0"),c("")):(c(t.cantidad||"0"),l(""),u("")),v("")},b=()=>{y(null),c(""),l(""),u(""),v("")},O=async()=>{if(!(!a||!r)){E(!0);try{const t=localStorage.getItem("auth_token");if(m(a)){const o=await fetch(`/api/inventario/ruta/${r}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({productoId:a.productoId,cantidad:I,tipo:"mixto_piezas",notas:x||void 0})});if(!o.ok){const n=await o.json().catch(()=>({}));throw new Error(n.error||"Error actualizando piezas")}const d=await fetch(`/api/inventario/ruta/${r}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({productoId:a.productoId,cantidad:z,tipo:"mixto_kg",notas:x||void 0})});if(!d.ok){const n=await d.json().catch(()=>({}));throw new Error(n.error||"Error actualizando kg")}}else{const o=a.productoUnidad==="KG"?"kg":"piezas",d=await fetch(`/api/inventario/ruta/${r}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({productoId:a.productoId,cantidad:w,tipo:o,notas:x||void 0})});if(!d.ok){const n=await d.json().catch(()=>({}));throw new Error(n.error||"Error actualizando inventario")}}g({title:"Guardado",description:"Inventario actualizado correctamente"}),b(),P(r)}catch(t){console.error("Error guardando:",t);const o=t instanceof Error?t.message:"No se pudo guardar";g({title:"Error",description:o,variant:"destructive"})}finally{E(!1)}}};return e.jsx(W,{title:"Stock de Rutas",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsx(i,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsx("div",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground",children:"Modificar Stock de Rutas"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Selecciona una ruta para ver y modificar su inventario. Los cambios se registran en movimientos."}),e.jsxs(Z,{value:r,onValueChange:_,children:[e.jsx(ee,{className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"select-ruta-stock",children:e.jsx(te,{placeholder:"Seleccionar ruta..."})}),e.jsx(ae,{className:"rounded-2xl max-h-[300px]",children:N.map(t=>e.jsx(se,{value:t.id.toString(),className:"font-bold","data-testid":`option-ruta-stock-${t.id}`,children:t.nombre},t.id))})]}),r&&e.jsx(ce,{value:f,onChange:L,placeholder:"Buscar producto...",testId:"search-stock-producto"})]})}),r?B?e.jsx(i,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center",children:e.jsx("div",{className:"text-xs font-bold text-muted-foreground uppercase",children:"Cargando inventario..."})}):e.jsx("div",{className:"grid gap-2",children:$.length===0&&M.length===0?e.jsxs(i,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin productos"}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:["No hay productos en el inventario de ",F]})]}):e.jsxs(e.Fragment,{children:[$.map(t=>e.jsx(i,{className:"p-4 rounded-2xl border-none shadow-sm bg-card/60",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-sm font-black truncate",children:t.productoNombre}),e.jsx("div",{className:"mt-1 text-xs font-bold text-muted-foreground",children:t.productoUnidad==="KG"?e.jsxs("span",{className:"text-primary",children:[parseFloat(t.cantidad||"0").toFixed(2)," KG"]}):e.jsxs("span",{className:"text-primary",children:[parseInt(t.cantidad||"0")," Piezas"]})})]}),e.jsxs(p,{variant:"secondary",size:"sm",className:"h-9 rounded-xl font-black uppercase text-[10px] gap-1",onClick:()=>K(t),"data-testid":`button-edit-stock-${t.productoId}`,children:[e.jsx(D,{className:"h-4 w-4"})," Editar"]})]})},`inv-${t.productoId}`)),M.map(t=>e.jsx(i,{className:"p-4 rounded-2xl border-none shadow-sm bg-card/60",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-black truncate",children:t.productoNombre}),e.jsx("span",{className:"text-[9px] bg-amber-500/20 text-amber-600 px-2 py-0.5 rounded-full font-bold",children:"MIXTO"})]}),e.jsxs("div",{className:"mt-1 text-xs font-bold text-muted-foreground flex gap-3",children:[e.jsxs("span",{className:"text-primary",children:[parseInt(t.cantidadPiezas||"0")," Piezas"]}),e.jsxs("span",{className:"text-primary",children:[parseFloat(t.cantidadKg||"0").toFixed(2)," KG"]})]})]}),e.jsxs(p,{variant:"secondary",size:"sm",className:"h-9 rounded-xl font-black uppercase text-[10px] gap-1",onClick:()=>K(t),"data-testid":`button-edit-mixto-${t.productoId}`,children:[e.jsx(D,{className:"h-4 w-4"})," Editar"]})]})},`mixto-${t.productoId}`))]})}):e.jsxs(i,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center",children:[e.jsx(Y,{className:"h-12 w-12 mx-auto text-muted-foreground/50"}),e.jsx("div",{className:"mt-4 text-sm font-bold",children:"Selecciona una ruta"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"Elige una ruta para ver y modificar su inventario."})]}),e.jsx(oe,{open:!!a,onOpenChange:t=>!t&&b(),children:e.jsxs(re,{className:"max-w-[95%] sm:max-w-[400px] rounded-3xl",children:[e.jsxs(ne,{children:[e.jsx(de,{className:"text-sm font-black uppercase tracking-widest text-center",children:"Modificar Stock"}),e.jsx(ie,{className:"text-center text-xs text-muted-foreground",children:a&&(m(a),a.productoNombre)})]}),e.jsxs("div",{className:"grid gap-4",children:[a&&m(a)?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs font-bold text-muted-foreground",children:"Piezas"}),e.jsx(h,{type:"number",value:I,onChange:t=>l(t.target.value),className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"input-edit-piezas"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs font-bold text-muted-foreground",children:"Kilogramos"}),e.jsx(h,{type:"number",step:"0.001",value:z,onChange:t=>u(t.target.value),className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"input-edit-kg"})]})]}):e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs font-bold text-muted-foreground",children:a&&a.productoUnidad==="KG"?"Kilogramos":"Piezas"}),e.jsx(h,{type:"number",step:a&&a.productoUnidad==="KG"?"0.001":"1",value:w,onChange:t=>c(t.target.value),className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"input-edit-cantidad"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs font-bold text-muted-foreground",children:"Notas (opcional)"}),e.jsx(h,{value:x,onChange:t=>v(t.target.value),placeholder:"Raz√≥n del ajuste...",className:"h-12 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"input-edit-notas"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{variant:"secondary",className:"flex-1 h-12 rounded-2xl font-black uppercase text-xs gap-2",onClick:b,children:[e.jsx(Q,{className:"h-4 w-4"})," Cancelar"]}),e.jsxs(p,{className:"flex-1 h-12 rounded-2xl font-black uppercase text-xs gap-2",onClick:O,disabled:C,"data-testid":"button-save-stock",children:[e.jsx(ue,{className:"h-4 w-4"})," ",C?"Guardando...":"Guardar"]})]})]})]})})]})})}export{Ne as default};
