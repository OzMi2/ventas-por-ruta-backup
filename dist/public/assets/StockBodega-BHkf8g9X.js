import{b as Z,r as a,j as e}from"./index-wdjF8QO9.js";import{A as ee,R as te,B as j,P as ae}from"./AppShell-dgPPhMBH.js";import{C as x}from"./card-BXHACzTM.js";import{B as s,I as N}from"./api-h81SHs0i.js";import{D as v,a as k,b as w,c as E,e as C}from"./dialog-Cc6_pB7Q.js";import{S as se}from"./search-DlaaPapW.js";import{S as oe}from"./scale-Dw4dD3tP.js";import{P as O}from"./pencil-D-j2D3xz.js";import{T as q}from"./trash-2-CAkFZMoM.js";function pe(){const{toast:d}=Z(),[z,G]=a.useState([]),[M,L]=a.useState([]),[S,P]=a.useState(!0),[n,U]=a.useState(""),[i,u]=a.useState(null),[D,$]=a.useState(""),[o,r]=a.useState(!1),[m,p]=a.useState(null),[h,g]=a.useState(null),[T,B]=a.useState(""),[A,F]=a.useState(""),[f,b]=a.useState(null),l=async()=>{P(!0);try{const t=localStorage.getItem("auth_token"),[c,K]=await Promise.all([fetch("/api/bodega",{headers:{Authorization:`Bearer ${t}`}}),fetch("/api/bodega/mixto",{headers:{Authorization:`Bearer ${t}`}})]);if(!c.ok)throw new Error("Error cargando bodega");const W=await c.json();if(G(W.inventario||[]),K.ok){const Y=await K.json();L(Y.inventario||[])}}catch{d({title:"Error",description:"No se pudo cargar el inventario de bodega.",variant:"destructive"})}finally{P(!1)}};a.useEffect(()=>{l()},[]);const R=t=>{u(t),$(parseFloat(t.cantidad).toString())},X=async()=>{if(i){r(!0);try{const t=localStorage.getItem("auth_token");if(!(await fetch(`/api/bodega/${i.productoId}`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({cantidad:parseFloat(D)||0})})).ok)throw new Error("Error actualizando");d({title:"Actualizado",description:"Stock actualizado correctamente."}),u(null),l()}catch{d({title:"Error",description:"No se pudo actualizar el stock.",variant:"destructive"})}finally{r(!1)}}},_=async()=>{if(m){r(!0);try{const t=localStorage.getItem("auth_token");if(!(await fetch(`/api/bodega/${m.productoId}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})).ok)throw new Error("Error eliminando");d({title:"Eliminado",description:"Producto eliminado de bodega."}),p(null),l()}catch{d({title:"Error",description:"No se pudo eliminar el producto.",variant:"destructive"})}finally{r(!1)}}},J=t=>{g(t),B((parseInt(t.cantidadPiezas)||0).toString()),F((parseFloat(t.cantidadKg)||0).toString())},H=async()=>{if(h){r(!0);try{const t=localStorage.getItem("auth_token");if(!(await fetch(`/api/bodega/mixto/${h.productoId}`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({piezas:parseInt(T)||0,kg:parseFloat(A)||0})})).ok)throw new Error("Error actualizando");d({title:"Actualizado",description:"Stock MIXTO actualizado correctamente."}),g(null),l()}catch{d({title:"Error",description:"No se pudo actualizar el stock.",variant:"destructive"})}finally{r(!1)}}},Q=async()=>{if(f){r(!0);try{const t=localStorage.getItem("auth_token");if(!(await fetch(`/api/bodega/mixto/${f.productoId}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})).ok)throw new Error("Error eliminando");d({title:"Eliminado",description:"Producto MIXTO eliminado de bodega."}),b(null),l()}catch{d({title:"Error",description:"No se pudo eliminar el producto.",variant:"destructive"})}finally{r(!1)}}},I=n.trim()?z.filter(t=>t.productoNombre.toLowerCase().includes(n.toLowerCase())||t.productoId.toString().includes(n)):z,y=n.trim()?M.filter(t=>t.productoNombre.toLowerCase().includes(n.toLowerCase())||t.productoId.toString().includes(n)):M,V=I.length+y.length;return e.jsxs(ee,{title:"Stock de Bodega",children:[e.jsxs("div",{className:"grid gap-6 pb-20",children:[e.jsxs("div",{className:"flex justify-between items-center px-1",children:[e.jsx("h2",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground",children:"Inventario Central"}),e.jsxs(s,{size:"sm",variant:"outline",onClick:l,disabled:S,className:"h-9 rounded-xl font-black uppercase text-[10px] gap-2","data-testid":"button-refresh",children:[e.jsx(te,{className:`h-3 w-3 ${S?"animate-spin":""}`})," Actualizar"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(N,{value:n,onChange:t=>U(t.target.value),placeholder:"Buscar producto...",className:"h-11 pl-10 rounded-2xl bg-muted/30 border-none font-bold","data-testid":"input-busqueda-bodega"})]}),e.jsxs(x,{className:"p-4 rounded-3xl bg-gradient-to-br from-blue-500/10 to-blue-500/5 border-none",children:[e.jsx("div",{className:"text-[9px] font-black uppercase text-muted-foreground",children:"Productos"}),e.jsx("div",{className:"text-2xl font-black text-blue-500",children:V})]}),e.jsx("div",{className:"grid gap-3",children:S?e.jsx(x,{className:"p-8 text-center rounded-3xl bg-muted/20 border-dashed",children:e.jsx("div",{className:"text-sm font-bold",children:"Cargando..."})}):I.length===0&&y.length===0?e.jsxs(x,{className:"p-8 text-center rounded-3xl bg-muted/20 border-dashed",children:[e.jsx("div",{className:"text-sm font-bold",children:n?"Sin coincidencias":"Sin productos en bodega"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:n?"No hay productos que coincidan con la búsqueda.":'Registra entradas de stock desde "Entrada bodega".'})]}):e.jsxs(e.Fragment,{children:[y.map(t=>e.jsx(x,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60","data-testid":`card-bodega-mixto-item-${t.productoId}`,children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"grid h-10 w-10 place-items-center rounded-2xl bg-purple-500/10",children:e.jsx(oe,{className:"h-5 w-5 text-purple-500"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{variant:"outline",className:"text-[8px] font-black",children:["ID: ",t.productoId]}),e.jsx(j,{className:"text-[8px] font-black uppercase bg-purple-500",children:"MIXTO"})]}),e.jsx("div",{className:"text-sm font-black mt-1",children:t.productoNombre})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-black text-primary",children:parseInt(t.cantidadPiezas)||0}),e.jsx("div",{className:"text-[9px] text-muted-foreground font-medium",children:"Piezas"})]}),e.jsx("div",{className:"text-muted-foreground font-bold",children:"/"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-black text-purple-500",children:parseFloat(t.cantidadKg).toFixed(2)}),e.jsx("div",{className:"text-[9px] text-muted-foreground font-medium",children:"Kg"})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(s,{size:"icon",variant:"ghost",className:"h-8 w-8 rounded-lg",onClick:()=>J(t),"data-testid":`button-edit-mixto-${t.productoId}`,children:e.jsx(O,{className:"h-4 w-4"})}),e.jsx(s,{size:"icon",variant:"ghost",className:"h-8 w-8 rounded-lg text-destructive",onClick:()=>b(t),"data-testid":`button-delete-mixto-${t.productoId}`,children:e.jsx(q,{className:"h-4 w-4"})})]})]})]})},`mixto-${t.id}`)),I.map(t=>e.jsx(x,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60","data-testid":`card-bodega-item-${t.productoId}`,children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"grid h-10 w-10 place-items-center rounded-2xl bg-primary/10",children:e.jsx(ae,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{variant:"outline",className:"text-[8px] font-black",children:["ID: ",t.productoId]}),e.jsx(j,{variant:"secondary",className:"text-[8px] font-black uppercase",children:t.productoUnidad})]}),e.jsx("div",{className:"text-sm font-black mt-1",children:t.productoNombre})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xl font-black text-primary",children:parseFloat(t.cantidad).toFixed(2)}),e.jsx("div",{className:"text-[9px] text-muted-foreground font-medium",children:t.productoUnidad==="KG"?"Kilogramos":"Piezas"})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(s,{size:"icon",variant:"ghost",className:"h-8 w-8 rounded-lg",onClick:()=>R(t),"data-testid":`button-edit-${t.productoId}`,children:e.jsx(O,{className:"h-4 w-4"})}),e.jsx(s,{size:"icon",variant:"ghost",className:"h-8 w-8 rounded-lg text-destructive",onClick:()=>p(t),"data-testid":`button-delete-${t.productoId}`,children:e.jsx(q,{className:"h-4 w-4"})})]})]})]})},t.id))]})})]}),e.jsx(v,{open:!!i,onOpenChange:t=>!t&&u(null),children:e.jsxs(k,{className:"max-w-[90%] rounded-3xl",children:[e.jsxs(w,{children:[e.jsx(E,{className:"text-lg font-black uppercase",children:"Editar Stock"}),e.jsxs(C,{children:["Modifica la cantidad de ",i?.productoNombre," en bodega."]})]}),e.jsxs("div",{className:"grid gap-4 mt-2",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsxs("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",children:["Cantidad (",i?.productoUnidad==="KG"?"Kilogramos":"Piezas",")"]}),e.jsx(N,{type:"number",step:i?.productoUnidad==="KG"?"0.001":"1",min:"0",value:D,onChange:t=>$(t.target.value),className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center","data-testid":"input-edit-cantidad"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(s,{variant:"outline",className:"flex-1 h-12 rounded-2xl font-bold",onClick:()=>u(null),disabled:o,children:"Cancelar"}),e.jsx(s,{className:"flex-1 h-12 rounded-2xl font-bold",onClick:X,disabled:o,"data-testid":"button-save-edit",children:o?"Guardando...":"Guardar"})]})]})]})}),e.jsx(v,{open:!!m,onOpenChange:t=>!t&&p(null),children:e.jsxs(k,{className:"max-w-[90%] rounded-3xl",children:[e.jsxs(w,{children:[e.jsx(E,{className:"text-lg font-black uppercase text-destructive",children:"Eliminar Producto"}),e.jsxs(C,{children:["¿Seguro que deseas eliminar ",m?.productoNombre," del inventario de bodega? Esta acción no se puede deshacer."]})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(s,{variant:"outline",className:"flex-1 h-12 rounded-2xl font-bold",onClick:()=>p(null),disabled:o,children:"Cancelar"}),e.jsx(s,{variant:"destructive",className:"flex-1 h-12 rounded-2xl font-bold",onClick:_,disabled:o,"data-testid":"button-confirm-delete",children:o?"Eliminando...":"Eliminar"})]})]})}),e.jsx(v,{open:!!h,onOpenChange:t=>!t&&g(null),children:e.jsxs(k,{className:"max-w-[90%] rounded-3xl",children:[e.jsxs(w,{children:[e.jsx(E,{className:"text-lg font-black uppercase",children:"Editar Stock MIXTO"}),e.jsxs(C,{children:["Modifica las cantidades de ",h?.productoNombre," en bodega."]})]}),e.jsxs("div",{className:"grid gap-4 mt-2",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",children:"Piezas"}),e.jsx(N,{type:"number",step:"1",min:"0",value:T,onChange:t=>B(t.target.value),className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center","data-testid":"input-edit-mixto-piezas"})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",children:"Kilogramos"}),e.jsx(N,{type:"number",step:"0.001",min:"0",value:A,onChange:t=>F(t.target.value),className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center","data-testid":"input-edit-mixto-kg"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(s,{variant:"outline",className:"flex-1 h-12 rounded-2xl font-bold",onClick:()=>g(null),disabled:o,children:"Cancelar"}),e.jsx(s,{className:"flex-1 h-12 rounded-2xl font-bold",onClick:H,disabled:o,"data-testid":"button-save-edit-mixto",children:o?"Guardando...":"Guardar"})]})]})]})}),e.jsx(v,{open:!!f,onOpenChange:t=>!t&&b(null),children:e.jsxs(k,{className:"max-w-[90%] rounded-3xl",children:[e.jsxs(w,{children:[e.jsx(E,{className:"text-lg font-black uppercase text-destructive",children:"Eliminar Producto MIXTO"}),e.jsxs(C,{children:["¿Seguro que deseas eliminar ",f?.productoNombre," del inventario de bodega? Esta acción no se puede deshacer."]})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(s,{variant:"outline",className:"flex-1 h-12 rounded-2xl font-bold",onClick:()=>b(null),disabled:o,children:"Cancelar"}),e.jsx(s,{variant:"destructive",className:"flex-1 h-12 rounded-2xl font-bold",onClick:Q,disabled:o,"data-testid":"button-confirm-delete-mixto",children:o?"Eliminando...":"Eliminar"})]})]})})]})}export{pe as default};
