import{b as te,r,j as e}from"./index-B_foZYmG.js";import{A as ae,R as se,U as ne,B as z}from"./AppShell-C0i3IliG.js";import{C}from"./card-BOyt3Fg8.js";import{B as l,I as x}from"./api-BvF3Zc_M.js";import{L as d}from"./label-B3OYdbl4.js";import{S as E,a as D,b as R,c as F,d as S}from"./select-j9o4lc39.js";import{D as V,a as L,b as _,c as q,d as G}from"./dialog-CwTbF-Ej.js";import{S as re}from"./SearchInput-DMXRaTAW.js";import{P as oe}from"./plus-CG2hWGoQ.js";import{P as ie}from"./pencil-C59hBgJA.js";import"./search-D8th6uVw.js";function je(){const{toast:i}=te(),[k,I]=r.useState([]),[f,U]=r.useState([]),[y,g]=r.useState(!0),[J,b]=r.useState(!1),[T,H]=r.useState(""),[c,K]=r.useState("todas"),[s,h]=r.useState({nombre:"",direccion:"",telefono:"",rutaId:""}),[j,B]=r.useState(null),[M,N]=r.useState(!1),[n,p]=r.useState({nombre:"",direccion:"",telefono:"",rutaId:""}),A=async()=>{g(!0);try{const a={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},[o,u]=await Promise.all([fetch("/api/rutas",{headers:a}),fetch("/api/clientes/todos",{headers:a})]);if(!o.ok)throw new Error("Error cargando rutas");const P=await o.json(),Z=(P.rutas||[]).sort((m,w)=>{const $=parseInt(m.nombre.replace(/\D/g,""))||0,ee=parseInt(w.nombre.replace(/\D/g,""))||0;return $-ee});if(U(Z),u.ok){const m=await u.json();I(m.clientes||[])}else{const m=P.rutas?.[0]?.id;if(m){const w=await fetch(`/api/clientes?rutaId=${m}`,{headers:a});if(w.ok){const $=await w.json();I($.clientes||[])}}}}catch{i({title:"Error",description:"No se pudieron cargar los datos.",variant:"destructive"})}finally{g(!1)}},v=async t=>{if(t==="todas"){A();return}g(!0);try{const a=localStorage.getItem("auth_token"),o=await fetch(`/api/clientes?rutaId=${t}`,{headers:{Authorization:`Bearer ${a}`}});if(!o.ok)throw new Error("Error cargando clientes");const u=await o.json();I(u.clientes||[])}catch{i({title:"Error",description:"No se pudieron cargar los clientes.",variant:"destructive"})}finally{g(!1)}};r.useEffect(()=>{A()},[]);const Q=async()=>{if(!s.nombre.trim()||!s.rutaId){i({title:"Validación",description:"Nombre y ruta son requeridos.",variant:"destructive"});return}try{const t=localStorage.getItem("auth_token"),a=await fetch("/api/clientes",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({nombre:s.nombre.trim(),rutaId:parseInt(s.rutaId),direccion:s.direccion.trim()||void 0,telefono:s.telefono.trim()||void 0})});if(!a.ok){const u=await a.json();throw new Error(u.error||"Error creando cliente")}const o=await a.json();i({title:"Éxito",description:`Cliente #${o.cliente.id} creado correctamente.`}),b(!1),h({nombre:"",direccion:"",telefono:"",rutaId:""}),(c==="todas"||c===s.rutaId)&&v(c)}catch(t){i({title:"Error",description:t.message,variant:"destructive"})}},W=t=>{B(t),p({nombre:t.nombre,direccion:t.direccion||"",telefono:t.telefono||"",rutaId:String(t.rutaId)}),N(!0)},X=async()=>{if(!j||!n.nombre.trim()||!n.rutaId){i({title:"Validación",description:"Nombre y ruta son requeridos.",variant:"destructive"});return}try{const t=localStorage.getItem("auth_token"),a=await fetch(`/api/clientes/${j.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({nombre:n.nombre.trim(),rutaId:parseInt(n.rutaId),direccion:n.direccion.trim()||null,telefono:n.telefono.trim()||null})});if(!a.ok){const o=await a.json();throw new Error(o.error||"Error actualizando cliente")}i({title:"Éxito",description:`Cliente #${j.id} actualizado.`}),N(!1),B(null),v(c)}catch(t){i({title:"Error",description:t.message,variant:"destructive"})}},O=k.filter(t=>`${t.id} ${t.nombre} ${t.direccion||""} ${t.telefono||""}`.toLowerCase().includes(T.toLowerCase())).sort((t,a)=>t.id-a.id),Y=t=>f.find(a=>a.id===t)?.nombre||`Ruta ${t}`;return e.jsxs(ae,{title:"Admin · Clientes",children:[e.jsxs("div",{className:"grid gap-4",children:[e.jsx(C,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground","data-testid":"text-clientes-header",children:"Gestión de Clientes"}),e.jsxs("div",{className:"text-sm font-bold","data-testid":"text-clientes-count",children:[k.length," clientes"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{variant:"secondary",className:"h-10 rounded-2xl font-black uppercase text-[10px] gap-2",onClick:()=>v(c),disabled:y,"data-testid":"button-refresh-clientes",children:e.jsx(se,{className:`h-4 w-4 ${y?"animate-spin":""}`})}),e.jsxs(l,{className:"h-10 rounded-2xl font-black uppercase text-[10px] gap-2",onClick:()=>b(!0),"data-testid":"button-nuevo-cliente",children:[e.jsx(oe,{className:"h-4 w-4"})," Nuevo"]})]})]}),e.jsxs("div",{className:"grid gap-2 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-muted-foreground uppercase mb-1 block",children:"Filtrar por Ruta"}),e.jsxs(E,{value:c,onValueChange:t=>{K(t),v(t)},children:[e.jsx(D,{className:"h-10 rounded-xl bg-muted/30 border-none font-bold text-sm","data-testid":"select-filtro-ruta",children:e.jsx(R,{placeholder:"Todas las rutas"})}),e.jsxs(F,{className:"rounded-xl max-h-60 overflow-y-auto",children:[e.jsx(S,{value:"todas",className:"font-bold",children:"Todas las rutas"}),f.map(t=>e.jsx(S,{value:String(t.id),className:"font-bold",children:t.nombre},t.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-muted-foreground uppercase mb-1 block",children:"Buscar"}),e.jsx(re,{value:T,onChange:H,placeholder:"ID, nombre, dirección...",testId:"search-clientes"})]})]})]})}),e.jsx("div",{className:"grid gap-2",children:y?e.jsx(C,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center","data-testid":"loading-clientes",children:e.jsx("div",{className:"text-xs font-bold text-muted-foreground uppercase",children:"Cargando…"})}):O.length===0?e.jsxs(C,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center","data-testid":"empty-clientes",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin clientes"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:k.length>0?"Sin coincidencias con la búsqueda.":"No hay clientes registrados."})]}):O.map(t=>e.jsx(C,{className:"p-4 rounded-2xl border-none shadow-sm bg-card/60","data-testid":`card-cliente-${t.id}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-xl bg-blue-100 text-blue-700",children:e.jsx(ne,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(z,{variant:"outline",className:"h-5 text-[9px] font-black","data-testid":`badge-cliente-id-${t.id}`,children:["#",t.id]}),e.jsx(z,{variant:t.activo?"default":"secondary",className:"h-5 text-[9px] font-black uppercase",children:t.activo?"Activo":"Inactivo"})]}),e.jsx("div",{className:"mt-2 text-sm font-black","data-testid":`text-cliente-nombre-${t.id}`,children:t.nombre}),e.jsxs("div",{className:"mt-1 flex items-center gap-4 text-[11px] font-bold text-muted-foreground flex-wrap",children:[e.jsxs("span",{"data-testid":`text-cliente-ruta-${t.id}`,children:["Ruta: ",e.jsx("span",{className:"text-foreground",children:Y(t.rutaId)})]}),t.telefono&&e.jsxs("span",{"data-testid":`text-cliente-telefono-${t.id}`,children:["Tel: ",e.jsx("span",{className:"text-foreground",children:t.telefono})]})]}),t.direccion&&e.jsx("div",{className:"mt-1 text-[11px] font-medium text-muted-foreground","data-testid":`text-cliente-direccion-${t.id}`,children:t.direccion})]}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-xl text-muted-foreground hover:text-foreground",onClick:()=>W(t),"data-testid":`button-edit-cliente-${t.id}`,children:e.jsx(ie,{className:"h-4 w-4"})})]})},t.id))})]}),e.jsx(V,{open:J,onOpenChange:b,children:e.jsxs(L,{className:"max-w-[95%] sm:max-w-[420px] rounded-3xl",children:[e.jsx(_,{children:e.jsx(q,{className:"text-sm font-black uppercase tracking-widest text-center",children:"Nuevo Cliente"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"nombre",className:"text-xs font-bold uppercase",children:"Nombre *"}),e.jsx(x,{id:"nombre",value:s.nombre,onChange:t=>h({...s,nombre:t.target.value}),placeholder:"Nombre del cliente",className:"h-12 rounded-xl bg-muted/30 border-none","data-testid":"input-cliente-nombre"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"ruta",className:"text-xs font-bold uppercase",children:"Ruta *"}),e.jsxs(E,{value:s.rutaId,onValueChange:t=>h({...s,rutaId:t}),children:[e.jsx(D,{className:"h-12 rounded-xl bg-muted/30 border-none font-bold","data-testid":"select-cliente-ruta",children:e.jsx(R,{placeholder:"Seleccionar ruta..."})}),e.jsx(F,{className:"rounded-xl max-h-60 overflow-y-auto",children:f.map(t=>e.jsx(S,{value:String(t.id),className:"font-bold",children:t.nombre},t.id))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"direccion",className:"text-xs font-bold uppercase",children:"Dirección"}),e.jsx(x,{id:"direccion",value:s.direccion,onChange:t=>h({...s,direccion:t.target.value}),placeholder:"Dirección (opcional)",className:"h-12 rounded-xl bg-muted/30 border-none","data-testid":"input-cliente-direccion"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"telefono",className:"text-xs font-bold uppercase",children:"Teléfono"}),e.jsx(x,{id:"telefono",value:s.telefono,onChange:t=>h({...s,telefono:t.target.value}),placeholder:"Teléfono (opcional)",className:"h-12 rounded-xl bg-muted/30 border-none","data-testid":"input-cliente-telefono"})]})]}),e.jsxs(G,{children:[e.jsx(l,{variant:"secondary",onClick:()=>b(!1),className:"rounded-xl font-bold","data-testid":"button-cancelar-cliente",children:"Cancelar"}),e.jsx(l,{onClick:Q,className:"rounded-xl font-bold","data-testid":"button-guardar-cliente",children:"Guardar"})]})]})}),e.jsx(V,{open:M,onOpenChange:N,children:e.jsxs(L,{className:"max-w-[95%] sm:max-w-[420px] rounded-3xl",children:[e.jsx(_,{children:e.jsxs(q,{className:"text-sm font-black uppercase tracking-widest text-center",children:["Editar Cliente #",j?.id]})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"edit-nombre",className:"text-xs font-bold uppercase",children:"Nombre *"}),e.jsx(x,{id:"edit-nombre",value:n.nombre,onChange:t=>p({...n,nombre:t.target.value}),placeholder:"Nombre del cliente",className:"h-12 rounded-xl bg-muted/30 border-none","data-testid":"input-edit-cliente-nombre"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"edit-ruta",className:"text-xs font-bold uppercase",children:"Ruta *"}),e.jsxs(E,{value:n.rutaId,onValueChange:t=>p({...n,rutaId:t}),children:[e.jsx(D,{className:"h-12 rounded-xl bg-muted/30 border-none font-bold","data-testid":"select-edit-cliente-ruta",children:e.jsx(R,{placeholder:"Seleccionar ruta..."})}),e.jsx(F,{className:"rounded-xl max-h-60 overflow-y-auto",children:f.map(t=>e.jsx(S,{value:String(t.id),className:"font-bold",children:t.nombre},t.id))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"edit-direccion",className:"text-xs font-bold uppercase",children:"Dirección"}),e.jsx(x,{id:"edit-direccion",value:n.direccion,onChange:t=>p({...n,direccion:t.target.value}),placeholder:"Dirección (opcional)",className:"h-12 rounded-xl bg-muted/30 border-none","data-testid":"input-edit-cliente-direccion"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"edit-telefono",className:"text-xs font-bold uppercase",children:"Teléfono"}),e.jsx(x,{id:"edit-telefono",value:n.telefono,onChange:t=>p({...n,telefono:t.target.value}),placeholder:"Teléfono (opcional)",className:"h-12 rounded-xl bg-muted/30 border-none","data-testid":"input-edit-cliente-telefono"})]})]}),e.jsxs(G,{children:[e.jsx(l,{variant:"secondary",onClick:()=>N(!1),className:"rounded-xl font-bold","data-testid":"button-cancelar-edit-cliente",children:"Cancelar"}),e.jsx(l,{onClick:X,className:"rounded-xl font-bold","data-testid":"button-guardar-edit-cliente",children:"Guardar Cambios"})]})]})})]})}export{je as default};
