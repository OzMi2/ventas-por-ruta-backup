import{c as he,u as fe,a as ge,r as c,j as e,X as be}from"./index-C3FIjBsS.js";import{A as ke,B as Q,S as X}from"./AppShell-DP6dkc32.js";import{b as W,a as J,s as U,B as _,I as P}from"./offlineCache-DoXVbz4G.js";import{C as M}from"./card-D08MNxaG.js";import{A as C,a as F,b as I}from"./alert-Bjj-s_4Y.js";import{D as ve,a as _e,b as je,c as Ne,d as Se}from"./dialog-DD5idXN4.js";import{S as V}from"./skeleton-CmGJuK18.js";import{S as we}from"./SearchInput-SskM3Udo.js";import{f as ze,a as Y}from"./discounts-aYW2GFZS.js";import{C as Ae}from"./circle-check-big-CqC5IX4s.js";import{A as ye}from"./arrow-right-ZpS-HHzy.js";import"./search-BqS688Ky.js";const Ce=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],Ie=he("triangle-alert",Ce),De=10,$e=5;function Pe(s){const i=[];for(const a of s)(a.tipo_venta==="unidad"||a.tipo_venta==="mixto")&&a.stock_piezas>0&&a.stock_piezas<=De&&i.push(`${a.nombre}: ${a.stock_piezas} piezas`),(a.tipo_venta==="peso"||a.tipo_venta==="mixto")&&a.stock_kg>0&&a.stock_kg<=$e&&i.push(`${a.nombre}: ${a.stock_kg.toFixed(2)} kg`);return i}let u=W();function Me(){try{const s=localStorage.getItem("vr_pending_ventas");if(!s)return{};const i=JSON.parse(s),a={};for(const m of i)for(const d of m.venta.items){const o=parseInt(String(d.producto_id));a[o]||(a[o]={piezas:0,kilos:0}),a[o].piezas+=d.cantidad||0,a[o].kilos+=d.kilos||0}return a}catch{return{}}}let L=0;const Fe=6e4;async function Le(){if(u){const s=Date.now();return navigator.onLine&&s-L>Fe&&(L=s,Ee()),u}try{return u=await J.bootstrap(),U(u),L=Date.now(),u}catch(s){const i=W();if(i)return u=i,u;throw s}}function Ee(){navigator.onLine&&J.bootstrap().then(s=>{u=s,U(s)}).catch(()=>{})}async function Ke(s){if(await Le(),!u)throw new Error("No data available");const i=u.inventario||[],a=u.inventarioMixto||[],m=Me();return u.productos.map(o=>{const b=o.unidad==="MIXTO",g=m[o.id]||{piezas:0,kilos:0};if(b){const p=a.find(k=>k.productoId===o.id),x=p&&parseInt(p.cantidadPiezas)||0,h=p&&parseFloat(p.cantidadKg)||0;return{id:o.id,nombre:o.nombre,precio_base:parseFloat(o.precio),tipo_venta:"peso",requiere_piezas:!0,precio_aplicado:parseFloat(o.precio),stock_piezas:Math.max(0,x-g.piezas),stock_kg:Math.max(0,h-g.kilos),unidad:"MIXTO"}}else{const p=i.find(j=>j.productoId===o.id),x=p?parseFloat(p.cantidad):0,h=o.unidad==="PIEZA"?Math.max(0,x-g.piezas):void 0,k=o.unidad==="KG"?Math.max(0,x-g.kilos):void 0;return{id:o.id,nombre:o.nombre,precio_base:parseFloat(o.precio),tipo_venta:o.unidad==="KG"?"peso":"unidad",requiere_piezas:!1,precio_aplicado:parseFloat(o.precio),stock_piezas:h,stock_kg:k,unidad:o.unidad}}})}function r(s){const i=Number(s);return Number.isFinite(i)?i:0}function Te(s,i){const a=s?.id??s?.producto_id??i,m=s?.tipo_venta==="peso"?"peso":"unidad",d=!!s?.requiere_piezas,o=s?.precio_aplicado!=null?r(s.precio_aplicado):r(s?.precio_base);return{id:String(a),nombre:String(s?.nombre??s?.producto??`Producto ${i+1}`),tipo_venta:m,requiere_piezas:d,stock_piezas:s?.stock_piezas!=null?r(s.stock_piezas):void 0,stock_kg:s?.stock_kg!=null?r(s.stock_kg):void 0,precio_base:r(s?.precio_base),descuento_aplicado:s?.descuento_aplicado!=null?r(s.descuento_aplicado):void 0,precio_aplicado:o,fuente_descuento:s?.fuente_descuento||"ninguno"}}function Be(s,i,a,m=[],d){const o=s.tipo_venta==="unidad"?r(i):r(a),b=d?parseInt(d):0,g=parseInt(s.id),p=s.tipo_venta==="unidad"?"PIEZA":"KG",x=b?Y(m,b,g,o,p):null,h=x?Math.max(r(s.precio_base)-x.discountAmount,0):r(s.precio_aplicado);return s.tipo_venta==="unidad"?r(i)*h:r(a)*h}function et(){const[,s]=fe(),{state:i,dispatch:a}=ge(),m=i.session?.usuario_id,d=i.selectedClient?.id,o=i.selectedClient?.nombre,[b,g]=c.useState(""),[p,x]=c.useState(!1),[h,k]=c.useState(null),[j,E]=c.useState([]),[K,ee]=c.useState([]),[te,A]=c.useState(!1),[n,se]=c.useState(null),[v,T]=c.useState(""),[N,B]=c.useState(""),[ae,oe]=c.useState(!0),[ie,D]=c.useState(!1),[ne,re]=c.useState("");async function q(){x(!0),k(null);try{const[t,f]=await Promise.all([Ke({vendedor_id:m,cliente_id:d}),ze()]),l=Array.isArray(t)?t:Array.isArray(t?.data)?t.data:[];E(l.map(Te)),ee(Array.isArray(f)?f:[])}catch(t){k(t?.message||"No se pudieron cargar los datos."),E([])}finally{x(!1)}}c.useEffect(()=>{q()},[m,d,o]);const O=j.filter(t=>t.nombre.toLowerCase().includes(b.trim().toLowerCase())),y=c.useMemo(()=>Pe(j.map(t=>({id:parseInt(t.id),nombre:t.nombre,tipo_venta:t.tipo_venta,stock_piezas:t.stock_piezas??0,stock_kg:t.stock_kg??0}))),[j]);function de(t){se(t),T(""),B(""),S(null),A(!0)}const[R,S]=c.useState(null);function ce(){if(!n)return;S(null);const t=n.tipo_venta,f=n.requiere_piezas,l=v.trim()?Number(v):void 0,w=N.trim()?Number(N):void 0;if(t==="unidad"){if(!l||l<=0)return;const z=r(n.stock_piezas);if(z<l){S(`Sin stock suficiente. Disponible: ${z} piezas`);return}}else{if(!w||w<=0||f&&(!l||l<=0))return;const z=r(n.stock_kg);if(z<w){S(`Sin stock suficiente. Disponible: ${z.toFixed(3)} kg`);return}if(f&&l){const Z=r(n.stock_piezas);if(Z<l){S(`Sin stock suficiente. Disponible: ${Z} piezas`);return}}}const pe=r(t==="unidad"?l:w),H=d?parseInt(d):0,me=parseInt(n.id),$=H?Y(K,H,me,pe,t==="unidad"?"PIEZA":"KG"):null,xe=$?Math.max(r(n.precio_base)-$.discountAmount,0):n.precio_aplicado;a({type:"CART_ADD",item:{producto_id:n.id,nombre:n.nombre,tipo_venta:n.tipo_venta,requiere_piezas:n.requiere_piezas,precio_base:n.precio_base,precio_aplicado:xe,discount_unit:$?.discountAmount||0,cantidad:t==="unidad"||f?l:void 0,kilos:t==="peso"?w:void 0}}),re(n.nombre),A(!1),D(!0),setTimeout(()=>D(!1),5e3)}const le=n?Be(n,v.trim()?Number(v):void 0,N.trim()?Number(N):void 0,K,d):0;return e.jsx(ke,{title:"Inventario",children:e.jsxs("div",{className:"grid gap-4",children:[i.selectedClient?null:e.jsxs(C,{variant:"destructive",className:"rounded-2xl shadow-sm border-none bg-destructive/10 text-destructive","data-testid":"alert-no-client",children:[e.jsx(F,{className:"text-xs font-black uppercase",children:"Atención"}),e.jsx(I,{className:"text-xs font-bold",children:"Selecciona un cliente antes de cargar productos."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(we,{value:b,onChange:g,placeholder:"Buscar producto...",testId:"search-productos"})}),e.jsx(_,{onClick:q,variant:"outline",size:"icon",className:"shrink-0 h-10 w-10 rounded-xl","data-testid":"button-refresh-productos",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),e.jsx("path",{d:"M3 3v5h5"}),e.jsx("path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"}),e.jsx("path",{d:"M16 16h5v5"})]})})]}),h?e.jsxs(C,{variant:"destructive",className:"rounded-2xl","data-testid":"alert-productos-error",children:[e.jsx(F,{children:"Error"}),e.jsx(I,{"data-testid":"text-productos-error",children:h})]}):null,ae&&y.length>0&&e.jsx(C,{className:"rounded-2xl bg-amber-500/10 border-amber-500/30","data-testid":"alert-low-stock",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-amber-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx(F,{className:"text-amber-700 text-sm font-bold",children:"Stock Bajo"}),e.jsxs(I,{className:"text-amber-600 text-xs mt-1",children:[y.slice(0,3).join(" · "),y.length>3&&` y ${y.length-3} más`]})]})]}),e.jsx(_,{variant:"ghost",size:"icon",className:"h-6 w-6 text-amber-600 hover:text-amber-700",onClick:()=>oe(!1),children:e.jsx(be,{className:"h-4 w-4"})})]})}),p?e.jsx("div",{className:"grid gap-2",children:Array.from({length:8}).map((t,f)=>e.jsxs(M,{className:"p-4 rounded-2xl","data-testid":`card-producto-skeleton-${f}`,children:[e.jsx(V,{className:"h-4 w-2/3"}),e.jsx(V,{className:"mt-2 h-3 w-1/2"})]},f))}):O.length===0?e.jsxs(M,{className:"p-8 text-center rounded-3xl bg-muted/20 border-dashed","data-testid":"empty-productos",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin productos"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"No hay coincidencias."})]}):e.jsx("div",{className:"grid gap-2",children:O.map(t=>e.jsx(M,{className:"p-3 shadow-sm active:scale-[0.98] transition-transform border-none bg-card/60 rounded-2xl","data-testid":`card-producto-${t.id}`,onClick:()=>de(t),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[e.jsx("div",{className:"truncate text-sm font-bold","data-testid":`text-producto-nombre-${t.id}`,children:t.nombre}),t.requiere_piezas?e.jsx(Q,{className:"h-5 text-[9px] px-1.5 uppercase tracking-wider font-black rounded-md bg-purple-500",children:"MIXTO"}):e.jsx(Q,{variant:"secondary",className:"h-5 text-[9px] px-1.5 uppercase tracking-wider font-black rounded-md",children:t.tipo_venta})]}),e.jsxs("div",{className:"mt-1 flex items-center gap-3 text-[11px] font-bold text-muted-foreground",children:[e.jsxs("div",{"data-testid":`text-precio-aplicado-${t.id}`,className:"text-primary",children:["$",t.precio_aplicado.toFixed(2)]}),e.jsx("div",{"data-testid":`text-stock-piezas-${t.id}`,className:"bg-muted/50 px-1.5 py-0.5 rounded text-[9px]",children:t.requiere_piezas?`${t.stock_piezas??0} PZS / ${(t.stock_kg??0).toFixed(2)} KG`:t.tipo_venta==="unidad"?`${t.stock_piezas??0} PZS`:`${(t.stock_kg??0).toFixed(3)} KG`})]})]}),e.jsx(_,{size:"icon",variant:"secondary",className:"h-10 w-10 rounded-full shrink-0 bg-background shadow-sm border-none","data-testid":`button-add-producto-${t.id}`,children:e.jsx(X,{className:"h-4 w-4 text-primary"})})]})},t.id))}),ie&&e.jsx("div",{className:"fixed bottom-[72px] sm:bottom-4 left-4 right-4 z-40 animate-in slide-in-from-bottom-4",children:e.jsx("div",{className:"rounded-2xl shadow-xl bg-green-600 text-white p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx(Ae,{className:"h-5 w-5 shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[10px] font-bold opacity-80",children:"Agregado"}),e.jsx("div",{className:"text-sm font-bold truncate",children:ne})]})]}),e.jsxs(_,{onClick:()=>{D(!1),s("/checkout")},className:"shrink-0 bg-white/20 hover:bg-white/30 text-white border-none h-9 px-3 rounded-xl font-bold text-xs","data-testid":"button-go-cart",children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Carrito (",i.cart.length,")",e.jsx(ye,{className:"h-3 w-3 ml-1"})]})]})})}),e.jsx(ve,{open:te,onOpenChange:A,children:e.jsxs(_e,{className:"max-w-[90%] rounded-3xl","data-testid":"modal-add-to-cart",children:[e.jsx(je,{children:e.jsx(Ne,{className:"text-lg font-black uppercase",children:"Agregar Item"})}),n?e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-black","data-testid":"text-modal-product-name",children:n.nombre}),e.jsxs("div",{className:"text-xs font-bold text-muted-foreground uppercase tracking-tight","data-testid":"text-modal-product-meta",children:[n.tipo_venta," · $",n.precio_aplicado.toFixed(2)," / ",n.tipo_venta==="unidad"?"pz":"kg"]})]}),n.tipo_venta==="unidad"?e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",htmlFor:"cantidad",children:"Cantidad (piezas)"}),e.jsx(P,{id:"cantidad",className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center",inputMode:"numeric",value:v,onChange:t=>G(t.target.value),placeholder:"0","data-testid":"input-cantidad"})]}):e.jsxs("div",{className:"grid gap-4",children:[n.requiere_piezas?e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",htmlFor:"cantidad2",children:"Piezas"}),e.jsx(P,{id:"cantidad2",className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center",inputMode:"numeric",value:v,onChange:t=>G(t.target.value),placeholder:"0","data-testid":"input-cantidad-piezas"})]}):null,e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",htmlFor:"kilos",children:"Kilos"}),e.jsx(P,{id:"kilos",className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center",inputMode:"decimal",value:N,onChange:t=>ue(t.target.value),placeholder:"0.00","data-testid":"input-kilos"})]})]}),e.jsxs("div",{className:"rounded-2xl bg-primary/5 p-4 flex justify-between items-center","data-testid":"text-modal-subtotal",children:[e.jsx("span",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{className:"text-xl font-black text-primary",children:["$",le.toFixed(2)]})]}),R&&e.jsx(C,{variant:"destructive",className:"rounded-2xl border-none","data-testid":"alert-stock-error",children:e.jsx(I,{className:"text-xs font-bold",children:R})})]}):null,e.jsxs(Se,{className:"flex-row gap-2 mt-2",children:[e.jsx(_,{variant:"secondary",className:"flex-1 h-12 rounded-2xl font-bold",onClick:()=>A(!1),"data-testid":"button-cancel-add",children:"Cerrar"}),e.jsx(_,{className:"flex-1 h-12 rounded-2xl font-black uppercase tracking-tighter",onClick:ce,"data-testid":"button-confirm-add",children:"Agregar"})]})]})})]})});function G(t){/^\d*$/.test(t)&&T(t)}function ue(t){/^\d*\.?\d*$/.test(t)&&B(t)}}export{et as default};
