import{c as ce,a as le,r as c,j as e,X as ue}from"./index-wdjF8QO9.js";import{a as Q,s as X,A as pe,B as H,S as me}from"./AppShell-dgPPhMBH.js";import{a as V,B as z,I as $}from"./api-h81SHs0i.js";import{C as M}from"./card-BXHACzTM.js";import{A as I,a as F,b as C}from"./alert-BA7vKpgV.js";import{D as xe,a as he,b as fe,c as ge,d as be}from"./dialog-Cc6_pB7Q.js";import{S as Z}from"./skeleton-BMt27klN.js";import{S as ke}from"./SearchInput-DsZDUsSf.js";import{f as _e,a as W}from"./discounts-CPVQNGsA.js";import"./search-DlaaPapW.js";const ve=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],je=ce("triangle-alert",ve),Ne=10,Se=5;function ze(s){const n=[];for(const a of s)(a.tipo_venta==="unidad"||a.tipo_venta==="mixto")&&a.stock_piezas>0&&a.stock_piezas<=Ne&&n.push(`${a.nombre}: ${a.stock_piezas} piezas`),(a.tipo_venta==="peso"||a.tipo_venta==="mixto")&&a.stock_kg>0&&a.stock_kg<=Se&&n.push(`${a.nombre}: ${a.stock_kg.toFixed(2)} kg`);return n}let p=Q();function we(){try{const s=localStorage.getItem("vr_pending_ventas");if(!s)return{};const n=JSON.parse(s),a={};for(const d of n)for(const m of d.venta.items){const o=parseInt(String(m.producto_id));a[o]||(a[o]={piezas:0,kilos:0}),a[o].piezas+=m.cantidad||0,a[o].kilos+=m.kilos||0}return a}catch{return{}}}let P=0;const ye=6e4;async function Ae(){if(p){const s=Date.now();return navigator.onLine&&s-P>ye&&(P=s,Ie()),p}try{return p=await V.bootstrap(),X(p),P=Date.now(),p}catch(s){const n=Q();if(n)return p=n,p;throw s}}function Ie(){navigator.onLine&&V.bootstrap().then(s=>{p=s,X(s)}).catch(()=>{})}async function Ce(s){if(await Ae(),!p)throw new Error("No data available");const n=p.inventario||[],a=p.inventarioMixto||[],d=we();return p.productos.map(o=>{const k=o.unidad==="MIXTO",g=d[o.id]||{piezas:0,kilos:0};if(k){const l=a.find(b=>b.productoId===o.id),x=l&&parseInt(l.cantidadPiezas)||0,h=l&&parseFloat(l.cantidadKg)||0;return{id:o.id,nombre:o.nombre,precio_base:parseFloat(o.precio),tipo_venta:"peso",requiere_piezas:!0,precio_aplicado:parseFloat(o.precio),stock_piezas:Math.max(0,x-g.piezas),stock_kg:Math.max(0,h-g.kilos),unidad:"MIXTO"}}else{const l=n.find(w=>w.productoId===o.id),x=l?parseFloat(l.cantidad):0,h=o.unidad==="PIEZA"?Math.max(0,x-g.piezas):void 0,b=o.unidad==="KG"?Math.max(0,x-g.kilos):void 0;return{id:o.id,nombre:o.nombre,precio_base:parseFloat(o.precio),tipo_venta:o.unidad==="KG"?"peso":"unidad",requiere_piezas:!1,precio_aplicado:parseFloat(o.precio),stock_piezas:h,stock_kg:b,unidad:o.unidad}}})}function r(s){const n=Number(s);return Number.isFinite(n)?n:0}function De(s,n){const a=s?.id??s?.producto_id??n,d=s?.tipo_venta==="peso"?"peso":"unidad",m=!!s?.requiere_piezas,o=s?.precio_aplicado!=null?r(s.precio_aplicado):r(s?.precio_base);return{id:String(a),nombre:String(s?.nombre??s?.producto??`Producto ${n+1}`),tipo_venta:d,requiere_piezas:m,stock_piezas:s?.stock_piezas!=null?r(s.stock_piezas):void 0,stock_kg:s?.stock_kg!=null?r(s.stock_kg):void 0,precio_base:r(s?.precio_base),descuento_aplicado:s?.descuento_aplicado!=null?r(s.descuento_aplicado):void 0,precio_aplicado:o,fuente_descuento:s?.fuente_descuento||"ninguno"}}function $e(s,n,a,d=[],m){const o=s.tipo_venta==="unidad"?r(n):r(a),k=m?parseInt(m):0,g=parseInt(s.id),l=s.tipo_venta==="unidad"?"PIEZA":"KG",x=k?W(d,k,g,o,l):null,h=x?Math.max(r(s.precio_base)-x.discountAmount,0):r(s.precio_aplicado);return s.tipo_venta==="unidad"?r(n)*h:r(a)*h}function Ge(){const{state:s,dispatch:n}=le(),a=s.session?.usuario_id,d=s.selectedClient?.id,m=s.selectedClient?.nombre,[o,k]=c.useState(""),[g,l]=c.useState(!1),[x,h]=c.useState(null),[b,w]=c.useState([]),[L,J]=c.useState([]),[U,y]=c.useState(!1),[i,Y]=c.useState(null),[_,E]=c.useState(""),[v,K]=c.useState(""),[ee,te]=c.useState(!0);async function T(){l(!0),h(null);try{const[t,f]=await Promise.all([Ce({vendedor_id:a,cliente_id:d}),_e()]),u=Array.isArray(t)?t:Array.isArray(t?.data)?t.data:[];w(u.map(De)),J(Array.isArray(f)?f:[])}catch(t){h(t?.message||"No se pudieron cargar los datos."),w([])}finally{l(!1)}}c.useEffect(()=>{T()},[a,d,m]);const q=b.filter(t=>t.nombre.toLowerCase().includes(o.trim().toLowerCase())),A=c.useMemo(()=>ze(b.map(t=>({id:parseInt(t.id),nombre:t.nombre,tipo_venta:t.tipo_venta,stock_piezas:t.stock_piezas??0,stock_kg:t.stock_kg??0}))),[b]);function se(t){Y(t),E(""),K(""),j(null),y(!0)}const[B,j]=c.useState(null);function ae(){if(!i)return;j(null);const t=i.tipo_venta,f=i.requiere_piezas,u=_.trim()?Number(_):void 0,N=v.trim()?Number(v):void 0;if(t==="unidad"){if(!u||u<=0)return;const S=r(i.stock_piezas);if(S<u){j(`Sin stock suficiente. Disponible: ${S} piezas`);return}}else{if(!N||N<=0||f&&(!u||u<=0))return;const S=r(i.stock_kg);if(S<N){j(`Sin stock suficiente. Disponible: ${S.toFixed(3)} kg`);return}if(f&&u){const G=r(i.stock_piezas);if(G<u){j(`Sin stock suficiente. Disponible: ${G} piezas`);return}}}const ne=r(t==="unidad"?u:N),R=d?parseInt(d):0,re=parseInt(i.id),D=R?W(L,R,re,ne,t==="unidad"?"PIEZA":"KG"):null,de=D?Math.max(r(i.precio_base)-D.discountAmount,0):i.precio_aplicado;n({type:"CART_ADD",item:{producto_id:i.id,nombre:i.nombre,tipo_venta:i.tipo_venta,requiere_piezas:i.requiere_piezas,precio_base:i.precio_base,precio_aplicado:de,discount_unit:D?.discountAmount||0,cantidad:t==="unidad"||f?u:void 0,kilos:t==="peso"?N:void 0}}),y(!1)}const oe=i?$e(i,_.trim()?Number(_):void 0,v.trim()?Number(v):void 0,L,d):0;return e.jsx(pe,{title:"Inventario",children:e.jsxs("div",{className:"grid gap-4",children:[s.selectedClient?null:e.jsxs(I,{variant:"destructive",className:"rounded-2xl shadow-sm border-none bg-destructive/10 text-destructive","data-testid":"alert-no-client",children:[e.jsx(F,{className:"text-xs font-black uppercase",children:"Atención"}),e.jsx(C,{className:"text-xs font-bold",children:"Selecciona un cliente antes de cargar productos."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(ke,{value:o,onChange:k,placeholder:"Buscar producto...",testId:"search-productos"})}),e.jsx(z,{onClick:T,variant:"outline",size:"icon",className:"shrink-0 h-10 w-10 rounded-xl","data-testid":"button-refresh-productos",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),e.jsx("path",{d:"M3 3v5h5"}),e.jsx("path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"}),e.jsx("path",{d:"M16 16h5v5"})]})})]}),x?e.jsxs(I,{variant:"destructive",className:"rounded-2xl","data-testid":"alert-productos-error",children:[e.jsx(F,{children:"Error"}),e.jsx(C,{"data-testid":"text-productos-error",children:x})]}):null,ee&&A.length>0&&e.jsx(I,{className:"rounded-2xl bg-amber-500/10 border-amber-500/30","data-testid":"alert-low-stock",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(je,{className:"h-4 w-4 text-amber-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx(F,{className:"text-amber-700 text-sm font-bold",children:"Stock Bajo"}),e.jsxs(C,{className:"text-amber-600 text-xs mt-1",children:[A.slice(0,3).join(" · "),A.length>3&&` y ${A.length-3} más`]})]})]}),e.jsx(z,{variant:"ghost",size:"icon",className:"h-6 w-6 text-amber-600 hover:text-amber-700",onClick:()=>te(!1),children:e.jsx(ue,{className:"h-4 w-4"})})]})}),g?e.jsx("div",{className:"grid gap-2",children:Array.from({length:8}).map((t,f)=>e.jsxs(M,{className:"p-4 rounded-2xl","data-testid":`card-producto-skeleton-${f}`,children:[e.jsx(Z,{className:"h-4 w-2/3"}),e.jsx(Z,{className:"mt-2 h-3 w-1/2"})]},f))}):q.length===0?e.jsxs(M,{className:"p-8 text-center rounded-3xl bg-muted/20 border-dashed","data-testid":"empty-productos",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin productos"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"No hay coincidencias."})]}):e.jsx("div",{className:"grid gap-2",children:q.map(t=>e.jsx(M,{className:"p-3 shadow-sm active:scale-[0.98] transition-transform border-none bg-card/60 rounded-2xl","data-testid":`card-producto-${t.id}`,onClick:()=>se(t),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[e.jsx("div",{className:"truncate text-sm font-bold","data-testid":`text-producto-nombre-${t.id}`,children:t.nombre}),t.requiere_piezas?e.jsx(H,{className:"h-5 text-[9px] px-1.5 uppercase tracking-wider font-black rounded-md bg-purple-500",children:"MIXTO"}):e.jsx(H,{variant:"secondary",className:"h-5 text-[9px] px-1.5 uppercase tracking-wider font-black rounded-md",children:t.tipo_venta})]}),e.jsxs("div",{className:"mt-1 flex items-center gap-3 text-[11px] font-bold text-muted-foreground",children:[e.jsxs("div",{"data-testid":`text-precio-aplicado-${t.id}`,className:"text-primary",children:["$",t.precio_aplicado.toFixed(2)]}),e.jsx("div",{"data-testid":`text-stock-piezas-${t.id}`,className:"bg-muted/50 px-1.5 py-0.5 rounded text-[9px]",children:t.requiere_piezas?`${t.stock_piezas??0} PZS / ${(t.stock_kg??0).toFixed(2)} KG`:t.tipo_venta==="unidad"?`${t.stock_piezas??0} PZS`:`${(t.stock_kg??0).toFixed(3)} KG`})]})]}),e.jsx(z,{size:"icon",variant:"secondary",className:"h-10 w-10 rounded-full shrink-0 bg-background shadow-sm border-none","data-testid":`button-add-producto-${t.id}`,children:e.jsx(me,{className:"h-4 w-4 text-primary"})})]})},t.id))}),e.jsx(xe,{open:U,onOpenChange:y,children:e.jsxs(he,{className:"max-w-[90%] rounded-3xl","data-testid":"modal-add-to-cart",children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-lg font-black uppercase",children:"Agregar Item"})}),i?e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-black","data-testid":"text-modal-product-name",children:i.nombre}),e.jsxs("div",{className:"text-xs font-bold text-muted-foreground uppercase tracking-tight","data-testid":"text-modal-product-meta",children:[i.tipo_venta," · $",i.precio_aplicado.toFixed(2)," / ",i.tipo_venta==="unidad"?"pz":"kg"]})]}),i.tipo_venta==="unidad"?e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",htmlFor:"cantidad",children:"Cantidad (piezas)"}),e.jsx($,{id:"cantidad",className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center",inputMode:"numeric",value:_,onChange:t=>O(t.target.value),placeholder:"0","data-testid":"input-cantidad"})]}):e.jsxs("div",{className:"grid gap-4",children:[i.requiere_piezas?e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",htmlFor:"cantidad2",children:"Piezas"}),e.jsx($,{id:"cantidad2",className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center",inputMode:"numeric",value:_,onChange:t=>O(t.target.value),placeholder:"0","data-testid":"input-cantidad-piezas"})]}):null,e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",htmlFor:"kilos",children:"Kilos"}),e.jsx($,{id:"kilos",className:"h-12 text-lg font-bold rounded-2xl bg-muted/30 border-none text-center",inputMode:"decimal",value:v,onChange:t=>ie(t.target.value),placeholder:"0.00","data-testid":"input-kilos"})]})]}),e.jsxs("div",{className:"rounded-2xl bg-primary/5 p-4 flex justify-between items-center","data-testid":"text-modal-subtotal",children:[e.jsx("span",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{className:"text-xl font-black text-primary",children:["$",oe.toFixed(2)]})]}),B&&e.jsx(I,{variant:"destructive",className:"rounded-2xl border-none","data-testid":"alert-stock-error",children:e.jsx(C,{className:"text-xs font-bold",children:B})})]}):null,e.jsxs(be,{className:"flex-row gap-2 mt-2",children:[e.jsx(z,{variant:"secondary",className:"flex-1 h-12 rounded-2xl font-bold",onClick:()=>y(!1),"data-testid":"button-cancel-add",children:"Cerrar"}),e.jsx(z,{className:"flex-1 h-12 rounded-2xl font-black uppercase tracking-tighter",onClick:ae,"data-testid":"button-confirm-add",children:"Agregar"})]})]})})]})});function O(t){/^\d*$/.test(t)&&E(t)}function ie(t){/^\d*\.?\d*$/.test(t)&&K(t)}}export{Ge as default};
