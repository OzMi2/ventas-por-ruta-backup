import{c as D,a as I,r as d,j as e}from"./index-tJdYnMtm.js";import{A as M,B as R}from"./AppShell-Dh3B1jwu.js";import{C as p}from"./card-hPFAobI0.js";import{B as l,I as L}from"./offlineCache-CkDYb09Y.js";import{S as E}from"./SearchInput-uvXwv8HS.js";import{F as B,c as z}from"./historial-DbMAKcm8.js";import{P,T as A,R as G}from"./TicketPrint-BqnlsLbI.js";import{a as H}from"./exportExcel-CTcARCXR.js";import{S as Q,a as Y,b as q,c as K,d as u}from"./select-BLjs4uxV.js";import{D as O}from"./download-4212kWnk.js";import"./search-BWHWkt37.js";import"./dialog--ekzEc0F.js";const X=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],J=D("calendar",X);function x(r){const s=Number(r);return Number.isFinite(s)?s:0}function c(r){return`$${x(r).toFixed(2)}`}function U(r){try{const s=new Date(r);return s.toLocaleDateString()+" "+s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return r}}function xe(){const{state:r}=I(),s=r.session?.usuario_id||"",g=r.session?.rol,$=g==="admin"||g==="auditor",[j,C]=d.useState(""),[_,N]=d.useState(!1),[T,F]=d.useState([]),[n,b]=d.useState(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}),[m,S]=d.useState("general"),[y,v]=d.useState(null),[V,k]=d.useState(!1);async function w(){if(s){N(!0);try{const t=await z({vendedorId:s});F(t)}finally{N(!1)}}}d.useEffect(()=>{w()},[s]);const i=T.filter(t=>{const a=`${t.folio} ${t.cliente_nombre}`.toLowerCase().includes(j.trim().toLowerCase());let o=!0;if(n){const f=new Date(t.fecha_iso);o=`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}-${String(f.getDate()).padStart(2,"0")}`===n}let h=!0;return m!=="general"&&(h=t.tipo_pago===m),a&&o&&h});return e.jsxs(M,{title:"Mi Historial",children:[e.jsxs("div",{className:"grid gap-4",children:[e.jsx(p,{className:"p-4 rounded-3xl border-none shadow-sm bg-card/60",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs font-black uppercase tracking-widest text-muted-foreground","data-testid":"text-mi-historial-header",children:"Ventas del vendedor"}),e.jsxs("div",{className:"text-sm font-bold","data-testid":"text-mi-historial-vendedor",children:["ID ",s]})]}),e.jsxs("div",{className:"flex gap-2",children:[$&&e.jsxs(l,{variant:"outline",className:"h-10 rounded-2xl font-black uppercase text-[10px] gap-1",onClick:()=>H(i,"mis_ventas"),disabled:i.length===0,"data-testid":"button-exportar-excel",children:[e.jsx(O,{className:"h-4 w-4"})," Excel"]}),e.jsxs(l,{variant:"outline",className:"h-10 rounded-2xl font-black uppercase text-[10px] gap-1",onClick:()=>k(!0),disabled:i.length===0,"data-testid":"button-generar-reporte",children:[e.jsx(B,{className:"h-4 w-4"})," Reporte"]}),e.jsx(l,{variant:"secondary",className:"h-10 rounded-2xl font-black uppercase text-[10px]",onClick:w,"data-testid":"button-refresh-mi-historial",children:"Refrescar"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(E,{value:j,onChange:C,placeholder:"Buscar por folio o cliente...",testId:"search-mi-historial"}),e.jsxs("div",{className:"relative",children:[e.jsx(J,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(L,{type:"date",value:n,onChange:t=>b(t.target.value),className:"h-10 pl-10 rounded-2xl bg-muted/30 border-none font-bold text-sm","data-testid":"input-filtro-fecha"})]})]}),e.jsxs(Q,{value:m,onValueChange:t=>S(t),children:[e.jsx(Y,{className:"h-10 rounded-2xl bg-muted/30 border-none font-bold text-sm","data-testid":"select-filtro-tipo",children:e.jsx(q,{placeholder:"Tipo de venta"})}),e.jsxs(K,{children:[e.jsx(u,{value:"general",children:"General (todas)"}),e.jsx(u,{value:"contado",children:"Contado"}),e.jsx(u,{value:"credito",children:"Credito"}),e.jsx(u,{value:"parcial",children:"Contado y credito (parcial)"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs font-bold text-muted-foreground",children:["Ventas mostradas: ",e.jsx("span",{className:"text-primary",children:i.length})]}),(n||m!=="general")&&e.jsx(l,{variant:"ghost",size:"sm",className:"h-7 text-xs font-bold",onClick:()=>{b(""),S("general")},"data-testid":"button-limpiar-filtros",children:"Limpiar filtros"})]})]})}),e.jsx("div",{className:"grid gap-2",children:_?e.jsx(p,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center","data-testid":"loading-mi-historial",children:e.jsx("div",{className:"text-xs font-bold text-muted-foreground uppercase",children:"Cargando…"})}):i.length===0?e.jsxs(p,{className:"p-10 rounded-3xl border-dashed bg-muted/20 text-center","data-testid":"empty-mi-historial",children:[e.jsx("div",{className:"text-sm font-bold",children:"Sin ventas"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground font-medium",children:"No hay datos para mostrar."})]}):i.map(t=>e.jsx(p,{className:"p-4 rounded-2xl border-none shadow-sm bg-card/60","data-testid":`card-mi-historial-venta-${t.id}`,children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{variant:"secondary",className:"h-5 text-[9px] font-black uppercase","data-testid":`badge-mi-historial-venta-${t.id}`,children:t.tipo_pago}),e.jsx("div",{className:"text-xs font-black","data-testid":`text-mi-historial-folio-${t.id}`,children:t.folio})]}),e.jsx("div",{className:"mt-1 text-[11px] font-bold text-muted-foreground","data-testid":`text-mi-historial-fecha-${t.id}`,children:U(t.fecha_iso)}),e.jsxs("div",{className:"mt-2 text-[11px] font-bold","data-testid":`text-mi-historial-cliente-${t.id}`,children:[e.jsx("span",{className:"text-muted-foreground",children:"Cliente:"})," ",t.cliente_nombre]}),e.jsxs("div",{className:"mt-1 text-[11px] font-bold","data-testid":`text-mi-historial-total-${t.id}`,children:[e.jsx("span",{className:"text-muted-foreground",children:"Total:"})," ",e.jsx("span",{className:"text-primary",children:c(t.total)}),t.descuentos>0?e.jsxs("span",{className:"text-muted-foreground",children:[" (dto -",c(t.descuentos),")"]}):null]}),(x(t.saldo_anterior)!==0||x(t.saldo_final)!==0)&&e.jsxs("div",{className:"mt-1 text-[10px] font-bold","data-testid":`text-mi-historial-saldo-${t.id}`,children:[e.jsx("span",{className:"text-muted-foreground",children:"Saldo:"})," ",e.jsx("span",{className:x(t.saldo_anterior)>0?"text-red-500":"text-green-600",children:c(t.saldo_anterior)}),e.jsx("span",{className:"text-muted-foreground mx-1",children:"→"}),e.jsx("span",{className:x(t.saldo_final)>0?"text-red-500":"text-green-600",children:c(t.saldo_final)})]}),t.vendedor_nombre&&e.jsxs("div",{className:"mt-1 text-[10px] font-bold text-muted-foreground","data-testid":`text-mi-historial-vendedor-${t.id}`,children:["Vendedor: ",e.jsx("span",{className:"text-foreground",children:t.vendedor_nombre})]}),t.items.length>0&&e.jsxs("div",{className:"mt-3 pt-2 border-t border-muted/30",children:[e.jsx("div",{className:"text-[10px] font-black uppercase text-muted-foreground mb-1",children:"Productos"}),e.jsx("div",{className:"grid gap-1",children:t.items.map((a,o)=>{const h=a.tipo_venta==="peso"||a.unidad==="KG"?`${a.kilos.toFixed(2)} kg`:a.unidad==="MIXTO"?`${a.cantidad} pz + ${a.kilos.toFixed(2)} kg`:`${a.cantidad} pz`;return e.jsxs("div",{className:"flex items-center justify-between text-[11px] font-bold","data-testid":`item-${t.id}-${o}`,children:[e.jsx("span",{className:"truncate flex-1",children:a.producto}),e.jsx("span",{className:"text-muted-foreground mx-2",children:h}),e.jsx("span",{className:"text-primary",children:c(a.subtotal)})]},o)})})]})]}),e.jsxs(l,{variant:"secondary",size:"sm",className:"h-8 rounded-xl font-black uppercase text-[10px] gap-2",onClick:()=>v(t),"data-testid":`button-print-mi-historial-${t.id}`,children:[e.jsx(P,{className:"h-4 w-4"})," Imprimir"]})]})},t.id))})]}),e.jsx(A,{venta:y,open:!!y,onClose:()=>v(null)}),e.jsx(G,{ventas:i,fecha:n,open:V,onClose:()=>k(!1)})]})}export{xe as default};
